
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../utils_faster_rcnn/">
      
      
        <link rel="next" href="../../../monitoring/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>Utils object detectors - Gabarit documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.35e1ed30.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#template_vision.models_training.object_detectors.utils_object_detectors" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Gabarit documentation" class="md-header__button md-logo" aria-label="Gabarit documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Gabarit documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Utils object detectors
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/OSS-Pole-Emploi/gabarit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OSS-Pole-Emploi/gabarit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Gabarit documentation" class="md-nav__button md-logo" aria-label="Gabarit documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Gabarit documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OSS-Pole-Emploi/gabarit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    OSS-Pole-Emploi/gabarit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../../frameworks/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Frameworks
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Frameworks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../frameworks/NLP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NLP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../frameworks/NUM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NUM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../frameworks/VISION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VISION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../frameworks/API/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_api/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Template api
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Template api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_api/core/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Core
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1_2" id="__nav_3_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/core/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/core/logtools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logtools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/core/resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resources
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_api/model/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Model
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            Model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/model/model_base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/model/model_gabarit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model gabarit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_api/routers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Routers
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            Routers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/routers/functional/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functional
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/routers/technical/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_api/routers/schemas/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Schemas
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_1_4_3" id="__nav_3_1_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4_3">
            <span class="md-nav__icon md-icon"></span>
            Schemas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/routers/schemas/functional/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functional
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/routers/schemas/technical/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_api/routers/schemas/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Template nlp
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Template nlp
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/models_training/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models training
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            Models training
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/model_aggregation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model aggregation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/model_class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model class
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/model_huggingface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model huggingface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/utils_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/models_training/hf_metrics/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Hf metrics
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_2_5" id="__nav_3_2_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2_5">
            <span class="md-nav__icon md-icon"></span>
            Hf metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/hf_metrics/accuracy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accuracy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/hf_metrics/f1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    F1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/hf_metrics/precision/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precision
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/hf_metrics/recall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recall
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/models_training/models_sklearn/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models sklearn
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_2_6" id="__nav_3_2_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2_6">
            <span class="md-nav__icon md-icon"></span>
            Models sklearn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_sklearn/model_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_sklearn/model_tfidf_gbt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model tfidf gbt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_sklearn/model_tfidf_lgbm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model tfidf lgbm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_sklearn/model_tfidf_sgdc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model tfidf sgdc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_sklearn/model_tfidf_svm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model tfidf svm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/models_training/models_tensorflow/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models tensorflow
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_2_7" id="__nav_3_2_2_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2_7">
            <span class="md-nav__icon md-icon"></span>
            Models tensorflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_embedding_cnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model embedding cnn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_embedding_lstm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model embedding lstm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_embedding_lstm_attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model embedding lstm attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_embedding_lstm_gru/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model embedding lstm gru
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_embedding_lstm_structured_attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model embedding lstm structured attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model keras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/model_tfidf_dense/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model tfidf dense
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/models_training/models_tensorflow/utils_deep_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils deep keras
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/monitoring/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_3" id="__nav_3_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_3">
            <span class="md-nav__icon md-icon"></span>
            Monitoring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/monitoring/mlflow_logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mlflow logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/monitoring/model_explainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model explainer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_nlp/preprocessing/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Preprocessing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2_4" id="__nav_3_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_4">
            <span class="md-nav__icon md-icon"></span>
            Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_nlp/preprocessing/preprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Template num
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Template num
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models training
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2" id="__nav_3_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2">
            <span class="md-nav__icon md-icon"></span>
            Models training
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/model_class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model class
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/model_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model keras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/model_pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/utils_deep_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils deep keras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/utils_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/classifiers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Classifiers
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_6" id="__nav_3_3_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_3_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_6">
            <span class="md-nav__icon md-icon"></span>
            Classifiers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/model_aggregation_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model aggregation classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/model_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/model_xgboost_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model xgboost classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_6_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/classifiers/models_sklearn/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models sklearn
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_6_4" id="__nav_3_3_2_6_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_3_3_2_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_6_4">
            <span class="md-nav__icon md-icon"></span>
            Models sklearn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_gbt_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model gbt classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_knn_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model knn classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_lgbm_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model lgbm classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_logistic_regression_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model logistic regression classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_rf_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model rf classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_ridge_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model ridge classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_sgd_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model sgd classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_sklearn/model_svm_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model svm classifier
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_6_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/classifiers/models_tensorflow/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models tensorflow
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_6_5" id="__nav_3_3_2_6_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_3_3_2_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_6_5">
            <span class="md-nav__icon md-icon"></span>
            Models tensorflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/classifiers/models_tensorflow/model_dense_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model dense classifier
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/regressors/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Regressors
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_7" id="__nav_3_3_2_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_3_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_7">
            <span class="md-nav__icon md-icon"></span>
            Regressors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/model_aggregation_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model aggregation regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/model_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/model_xgboost_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model xgboost regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_7_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/regressors/models_sklearn/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models sklearn
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_7_4" id="__nav_3_3_2_7_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_3_3_2_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_7_4">
            <span class="md-nav__icon md-icon"></span>
            Models sklearn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_bayesian_ridge_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model bayesian ridge regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_elasticnet_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model elasticnet regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_gbt_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model gbt regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_kernel_ridge_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model kernel ridge regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_knn_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model knn regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_lgbm_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model lgbm regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_pls_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model pls regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_rf_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model rf regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_sgd_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model sgd regressor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_sklearn/model_svr_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model svr regressor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2_7_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/models_training/regressors/models_tensorflow/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models tensorflow
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_2_7_5" id="__nav_3_3_2_7_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_3_3_2_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_2_7_5">
            <span class="md-nav__icon md-icon"></span>
            Models tensorflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/models_training/regressors/models_tensorflow/model_dense_regressor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model dense regressor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/monitoring/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_3" id="__nav_3_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_3">
            <span class="md-nav__icon md-icon"></span>
            Monitoring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/monitoring/mlflow_logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mlflow logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/monitoring/model_explainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model explainer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../template_num/preprocessing/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Preprocessing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/preprocessing/column_preprocessors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Column preprocessors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/preprocessing/outlier_detection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Outlier detection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../../template_num/preprocessing/preprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Template vision
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Template vision
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Models training
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            Models training
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../model_class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model class
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../model_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model keras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../utils_deep_keras/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils deep keras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../utils_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../classifiers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Classifiers
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4_2_5" id="__nav_3_4_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_4_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2_5">
            <span class="md-nav__icon md-icon"></span>
            Classifiers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../classifiers/model_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../classifiers/model_cnn_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model cnn classifier
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../classifiers/model_transfer_learning_classifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model transfer learning classifier
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Object detectors
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4_2_6" id="__nav_3_4_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_4_2_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_4_2_6">
            <span class="md-nav__icon md-icon"></span>
            Object detectors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../model_detectron_faster_rcnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model detectron faster rcnn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../model_keras_faster_rcnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model keras faster rcnn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../model_object_detector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model object detector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../utils_faster_rcnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils faster rcnn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Utils object detectors
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Utils object detectors
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors" class="md-nav__link">
    utils_object_detectors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.add_regression_target_to_pos_valid" class="md-nav__link">
    add_regression_target_to_pos_valid()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.apply_regression" class="md-nav__link">
    apply_regression()
  </a>
  
    <nav class="md-nav" aria-label="apply_regression()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.apply_regression--shape-8" class="md-nav__link">
    Shape (8,)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.calc_regr" class="md-nav__link">
    calc_regr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.check_coordinates_validity" class="md-nav__link">
    check_coordinates_validity()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.complete_at_least_one_anchor_per_bbox" class="md-nav__link">
    complete_at_least_one_anchor_per_bbox()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.create_fake_dict_rois_targets" class="md-nav__link">
    create_fake_dict_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes" class="md-nav__link">
    draw_bboxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes_from_file" class="md-nav__link">
    draw_bboxes_from_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_rectangle_from_bbox" class="md-nav__link">
    draw_rectangle_from_bbox()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.format_classifier_inputs_and_targets" class="md-nav__link">
    format_classifier_inputs_and_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_all_viable_anchors_boxes" class="md-nav__link">
    get_all_viable_anchors_boxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_area_from_xyxy" class="md-nav__link">
    get_area_from_xyxy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_test_inputs" class="md-nav__link">
    get_classifier_test_inputs()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets" class="md-nav__link">
    get_classifier_train_inputs_and_targets()
  </a>
  
    <nav class="md-nav" aria-label="get_classifier_train_inputs_and_targets()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets--format-x1-y1-x2-y2-opposite-points" class="md-nav__link">
    Format x1, y1, x2, y2 (opposite points)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_feature_map_size" class="md-nav__link">
    get_feature_map_size()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes" class="md-nav__link">
    get_final_bboxes()
  </a>
  
    <nav class="md-nav" aria-label="get_final_bboxes()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes--format-cl-proba-coordinates" class="md-nav__link">
    Format [(cl, proba, coordinates), (...), ...)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_iou" class="md-nav__link">
    get_iou()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_iou_anchors_bboxes" class="md-nav__link">
    get_iou_anchors_bboxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_new_img_size_from_min_side_size" class="md-nav__link">
    get_new_img_size_from_min_side_size()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions" class="md-nav__link">
    get_roi_from_rpn_predictions()
  </a>
  
    <nav class="md-nav" aria-label="get_roi_from_rpn_predictions()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-nb_anchor" class="md-nav__link">
    shape: (batch_size, height_feature_map, width_feature_map, nb_anchor)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-4-nb_anchor" class="md-nav__link">
    shape: (batch_size, height_feature_map, width_feature_map, 4 * nb_anchor)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou" class="md-nav__link">
    get_rois_bboxes_iou()
  </a>
  
    <nav class="md-nav" aria-label="get_rois_bboxes_iou()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou--shape-n-4-n-corresponds-to-the-number-of-given-rois-in-general-max-300-cf-modelnms_max_boxes" class="md-nav__link">
    Shape (N, 4), N corresponds to the number of given ROIs (in general max 300, cf. model.nms_max_boxes)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_targets" class="md-nav__link">
    get_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rpn_targets" class="md-nav__link">
    get_rpn_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_valid_boxes_from_coordinates" class="md-nav__link">
    get_valid_boxes_from_coordinates()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_valid_fm_boxes_from_proba" class="md-nav__link">
    get_valid_fm_boxes_from_proba()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.limit_rois_targets" class="md-nav__link">
    limit_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast" class="md-nav__link">
    non_max_suppression_fast()
  </a>
  
    <nav class="md-nav" aria-label="non_max_suppression_fast()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes-4" class="md-nav__link">
    shape: (nb_boxes, 4)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes" class="md-nav__link">
    shape: (nb_boxes)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds" class="md-nav__link">
    non_max_suppression_fast_on_preds()
  </a>
  
    <nav class="md-nav" aria-label="non_max_suppression_fast_on_preds()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds--format-cl-proba-coordinates" class="md-nav__link">
    Format [(cl, proba, coordinates), (...), ...)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.restrict_and_convert_roi_boxes" class="md-nav__link">
    restrict_and_convert_roi_boxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.restrict_valid_to_n_regions" class="md-nav__link">
    restrict_valid_to_n_regions()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois" class="md-nav__link">
    select_final_rois()
  </a>
  
    <nav class="md-nav" aria-label="select_final_rois()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois-4" class="md-nav__link">
    shape: (batch_size, nb_rois, 4)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois" class="md-nav__link">
    shape: (batch_size, nb_rois)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.set_anchors_type_validity" class="md-nav__link">
    set_anchors_type_validity()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyhw_to_xyxy" class="md-nav__link">
    xyhw_to_xyxy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_cxcyhw" class="md-nav__link">
    xyxy_to_cxcyhw()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_xyhw" class="md-nav__link">
    xyxy_to_xyhw()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../monitoring/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            Monitoring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../monitoring/mlflow_logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mlflow logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../monitoring/model_explainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model explainer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../preprocessing/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Preprocessing
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4_4" id="__nav_3_4_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_4">
            <span class="md-nav__icon md-icon"></span>
            Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../preprocessing/manage_white_borders/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manage white borders
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../preprocessing/preprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocess
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors" class="md-nav__link">
    utils_object_detectors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.add_regression_target_to_pos_valid" class="md-nav__link">
    add_regression_target_to_pos_valid()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.apply_regression" class="md-nav__link">
    apply_regression()
  </a>
  
    <nav class="md-nav" aria-label="apply_regression()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.apply_regression--shape-8" class="md-nav__link">
    Shape (8,)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.calc_regr" class="md-nav__link">
    calc_regr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.check_coordinates_validity" class="md-nav__link">
    check_coordinates_validity()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.complete_at_least_one_anchor_per_bbox" class="md-nav__link">
    complete_at_least_one_anchor_per_bbox()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.create_fake_dict_rois_targets" class="md-nav__link">
    create_fake_dict_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes" class="md-nav__link">
    draw_bboxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes_from_file" class="md-nav__link">
    draw_bboxes_from_file()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.draw_rectangle_from_bbox" class="md-nav__link">
    draw_rectangle_from_bbox()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.format_classifier_inputs_and_targets" class="md-nav__link">
    format_classifier_inputs_and_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_all_viable_anchors_boxes" class="md-nav__link">
    get_all_viable_anchors_boxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_area_from_xyxy" class="md-nav__link">
    get_area_from_xyxy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_test_inputs" class="md-nav__link">
    get_classifier_test_inputs()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets" class="md-nav__link">
    get_classifier_train_inputs_and_targets()
  </a>
  
    <nav class="md-nav" aria-label="get_classifier_train_inputs_and_targets()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets--format-x1-y1-x2-y2-opposite-points" class="md-nav__link">
    Format x1, y1, x2, y2 (opposite points)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_feature_map_size" class="md-nav__link">
    get_feature_map_size()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes" class="md-nav__link">
    get_final_bboxes()
  </a>
  
    <nav class="md-nav" aria-label="get_final_bboxes()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes--format-cl-proba-coordinates" class="md-nav__link">
    Format [(cl, proba, coordinates), (...), ...)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_iou" class="md-nav__link">
    get_iou()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_iou_anchors_bboxes" class="md-nav__link">
    get_iou_anchors_bboxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_new_img_size_from_min_side_size" class="md-nav__link">
    get_new_img_size_from_min_side_size()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions" class="md-nav__link">
    get_roi_from_rpn_predictions()
  </a>
  
    <nav class="md-nav" aria-label="get_roi_from_rpn_predictions()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-nb_anchor" class="md-nav__link">
    shape: (batch_size, height_feature_map, width_feature_map, nb_anchor)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-4-nb_anchor" class="md-nav__link">
    shape: (batch_size, height_feature_map, width_feature_map, 4 * nb_anchor)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou" class="md-nav__link">
    get_rois_bboxes_iou()
  </a>
  
    <nav class="md-nav" aria-label="get_rois_bboxes_iou()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou--shape-n-4-n-corresponds-to-the-number-of-given-rois-in-general-max-300-cf-modelnms_max_boxes" class="md-nav__link">
    Shape (N, 4), N corresponds to the number of given ROIs (in general max 300, cf. model.nms_max_boxes)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rois_targets" class="md-nav__link">
    get_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_rpn_targets" class="md-nav__link">
    get_rpn_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_valid_boxes_from_coordinates" class="md-nav__link">
    get_valid_boxes_from_coordinates()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.get_valid_fm_boxes_from_proba" class="md-nav__link">
    get_valid_fm_boxes_from_proba()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.limit_rois_targets" class="md-nav__link">
    limit_rois_targets()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast" class="md-nav__link">
    non_max_suppression_fast()
  </a>
  
    <nav class="md-nav" aria-label="non_max_suppression_fast()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes-4" class="md-nav__link">
    shape: (nb_boxes, 4)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes" class="md-nav__link">
    shape: (nb_boxes)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds" class="md-nav__link">
    non_max_suppression_fast_on_preds()
  </a>
  
    <nav class="md-nav" aria-label="non_max_suppression_fast_on_preds()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds--format-cl-proba-coordinates" class="md-nav__link">
    Format [(cl, proba, coordinates), (...), ...)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.restrict_and_convert_roi_boxes" class="md-nav__link">
    restrict_and_convert_roi_boxes()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.restrict_valid_to_n_regions" class="md-nav__link">
    restrict_valid_to_n_regions()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois" class="md-nav__link">
    select_final_rois()
  </a>
  
    <nav class="md-nav" aria-label="select_final_rois()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois-4" class="md-nav__link">
    shape: (batch_size, nb_rois, 4)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois" class="md-nav__link">
    shape: (batch_size, nb_rois)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.set_anchors_type_validity" class="md-nav__link">
    set_anchors_type_validity()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyhw_to_xyxy" class="md-nav__link">
    xyhw_to_xyxy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_cxcyhw" class="md-nav__link">
    xyxy_to_cxcyhw()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_xyhw" class="md-nav__link">
    xyxy_to_xyhw()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Utils object detectors</h1>

<div class="doc doc-object doc-module">



<a id="template_vision.models_training.object_detectors.utils_object_detectors"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.add_regression_target_to_pos_valid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_regression_target_to_pos_valid</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Add the regression target for positive and valid anchors
Otherwise, keep (0, 0, 0, 0) and won't be used by the loss</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>anchor_boxes_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Anchor boxes dictionary
- 'anchor_img_coordinates': Coordinates of the anchor box (input format ie. image space)
- 'bboxes': bboxes with their coordinates xyxy (in image space) and iou
- 'anchor_type': anchor type (pos, neg or neutral)
- 'anchor_validity': anchor validity
- 'best_bbox_index': bbox associated to this anchor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: Updated anchor boxes withe the regression targets</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="k">def</span> <span class="nf">add_regression_target_to_pos_valid</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Add the regression target for positive and valid anchors</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a><span class="sd">    Otherwise, keep (0, 0, 0, 0) and won&#39;t be used by the loss</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a><span class="sd">        anchor_boxes_dict (dict): Anchor boxes dictionary</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a><span class="sd">            - &#39;anchor_img_coordinates&#39;: Coordinates of the anchor box (input format ie. image space)</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a><span class="sd">            - &#39;bboxes&#39;: bboxes with their coordinates xyxy (in image space) and iou</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a><span class="sd">            - &#39;anchor_type&#39;: anchor type (pos, neg or neutral)</span>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a><span class="sd">            - &#39;anchor_validity&#39;: anchor validity</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a><span class="sd">            - &#39;best_bbox_index&#39;: bbox associated to this anchor</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a><span class="sd">        dict: Updated anchor boxes withe the regression targets</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>    <span class="c1"># For each anchor ...</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>    <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>        <span class="c1"># ... and if the anchor is positive and valid ...</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>        <span class="k">if</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">and</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>            <span class="c1"># ... we get the regression target between this anchor and the closest bbox (best iou)</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="n">coordinates_anchor</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_img_coordinates&#39;</span><span class="p">]</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>            <span class="n">best_bbox_index</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>            <span class="n">coordinates_bbox</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">best_bbox_index</span><span class="p">][</span><span class="s1">&#39;bbox_img_coordinates&#39;</span><span class="p">]</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;regression_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_regr</span><span class="p">(</span><span class="n">coordinates_bbox</span><span class="p">,</span> <span class="n">coordinates_anchor</span><span class="p">)</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>        <span class="c1"># Otherwise, default to 0</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;regression_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>        <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>    <span class="c1"># Return updated dict</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>    <span class="k">return</span> <span class="n">anchor_boxes_dict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.apply_regression" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">apply_regression</span><span class="p">(</span><span class="n">coordinates_and_regression</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Applies the result of a regression on an anchor box (or a ROI) given in xyhw format.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>coordinates_and_regression</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An array composed of 8 objects x_anc, y_anc, h_anc, w_anc, tx, ty, th, tw.
(x_anc, y_anc, h_anc, w_anc) are the coordinates of the anchor (or of a ROI)
(tx, ty, th, tw) are the predictions of a regression</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.apply_regression--shape-8">Shape (8,)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    float: coordinates after regression applied on the anchor box (or on the ROI) - x coordinate of the upper left corner
    float: coordinates after regression applied on the anchor box (or on the ROI) - y coordinate of the upper left corner
    float: coordinates after regression applied on the anchor box (or on the ROI) - height
    float: coordinates after regression applied on the anchor box (or on the ROI) - width</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="k">def</span> <span class="nf">apply_regression</span><span class="p">(</span><span class="n">coordinates_and_regression</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Applies the result of a regression on an anchor box (or a ROI) given in xyhw format.</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        coordinates_and_regression (np.ndarray): An array composed of 8 objects x_anc, y_anc, h_anc, w_anc, tx, ty, th, tw.</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">            (x_anc, y_anc, h_anc, w_anc) are the coordinates of the anchor (or of a ROI)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a><span class="sd">            (tx, ty, th, tw) are the predictions of a regression</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">            # Shape (8,)</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">        float: coordinates after regression applied on the anchor box (or on the ROI) - x coordinate of the upper left corner</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">        float: coordinates after regression applied on the anchor box (or on the ROI) - y coordinate of the upper left corner</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="sd">        float: coordinates after regression applied on the anchor box (or on the ROI) - height</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="sd">        float: coordinates after regression applied on the anchor box (or on the ROI) - width</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="n">x_anc</span><span class="p">,</span> <span class="n">y_anc</span><span class="p">,</span> <span class="n">h_anc</span><span class="p">,</span> <span class="n">w_anc</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">tw</span> <span class="o">=</span> <span class="n">coordinates_and_regression</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">w_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tw</span><span class="p">)</span> <span class="o">*</span> <span class="n">w_anc</span>  <span class="c1"># Take the inverse of the log and get rid of the normalization</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">h_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">*</span> <span class="n">h_anc</span>  <span class="c1"># Take the inverse of the log and get rid of the normalization</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="n">x_roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span> <span class="o">*</span> <span class="n">w_anc</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_anc</span> <span class="o">+</span> <span class="n">w_anc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">w_roi</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Get rid of the normalization, then add the center of the anchor = center of ROI, then remove half the width to get x1</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">y_roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ty</span> <span class="o">*</span> <span class="n">h_anc</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_anc</span> <span class="o">+</span> <span class="n">h_anc</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">h_roi</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Get rid of the normalization, then add the center of the anchor = center of ROI, then remove half the height to get y1</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="k">return</span> <span class="n">x_roi</span><span class="p">,</span> <span class="n">y_roi</span><span class="p">,</span> <span class="n">h_roi</span><span class="p">,</span> <span class="n">w_roi</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.calc_regr" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">calc_regr</span><span class="p">(</span><span class="n">coordinates_bbox</span><span class="p">,</span> <span class="n">coordinates_anchor</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the target of a regression given the coordinates of a bbox and of an anchor (or a ROI)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>coordinates_bbox</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The coordinates of a bbox in opposite points format</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>coordinates_anchor</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The coordinates of an anchor (or a ROI) in opposite points format</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    float: Gap between the centers (x coordinate) normalized by the width of the anchor
    float: Gap between the centers (y coordinate) normalized by the height of the anchor
    float: Height ratio : bbox / anchor (log version)
    float: Width ratio : bbox / anchor (log version)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="k">def</span> <span class="nf">calc_regr</span><span class="p">(</span><span class="n">coordinates_bbox</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>              <span class="n">coordinates_anchor</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the target of a regression given the coordinates of a bbox and of an anchor (or a ROI)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        coordinates_bbox (tuple): The coordinates of a bbox in opposite points format</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        coordinates_anchor (tuple): The coordinates of an anchor (or a ROI) in opposite points format</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        float: Gap between the centers (x coordinate) normalized by the width of the anchor</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        float: Gap between the centers (y coordinate) normalized by the height of the anchor</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">        float: Height ratio : bbox / anchor (log version)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        float: Width ratio : bbox / anchor (log version)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="n">cx_bbox</span><span class="p">,</span> <span class="n">cy_bbox</span><span class="p">,</span> <span class="n">height_bbox</span><span class="p">,</span> <span class="n">width_bbox</span> <span class="o">=</span> <span class="n">xyxy_to_cxcyhw</span><span class="p">(</span><span class="o">*</span><span class="n">coordinates_bbox</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="n">cx_anchor</span><span class="p">,</span> <span class="n">cy_anchor</span><span class="p">,</span> <span class="n">height_anchor</span><span class="p">,</span> <span class="n">width_anchor</span> <span class="o">=</span> <span class="n">xyxy_to_cxcyhw</span><span class="p">(</span><span class="o">*</span><span class="n">coordinates_anchor</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_bbox</span> <span class="o">-</span> <span class="n">cx_anchor</span><span class="p">)</span> <span class="o">/</span> <span class="n">width_anchor</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">cy_bbox</span> <span class="o">-</span> <span class="n">cy_anchor</span><span class="p">)</span> <span class="o">/</span> <span class="n">height_anchor</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">height_bbox</span> <span class="o">/</span> <span class="n">height_anchor</span><span class="p">)</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="n">tw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">width_bbox</span> <span class="o">/</span> <span class="n">width_anchor</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="k">return</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">tw</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.check_coordinates_validity" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_coordinates_validity</span><span class="p">(</span><span class="n">function</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Decorator to make sure that the coordinates are valid</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>function</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Function to decorate</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Raises:
    ValueError: If a set of coordinates is impossible
Returns:
    function: The decorated function</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="k">def</span> <span class="nf">check_coordinates_validity</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Decorator to make sure that the coordinates are valid</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        function (Callable): Function to decorate</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        ValueError: If a set of coordinates is impossible</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        function: The decorated function</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="c1"># Get wrapper</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Wrapper&#39;&#39;&#39;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="c1"># Get vars.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">f_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;x1&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">y1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;y1&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;y1&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;y1&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;x2&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;x2&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">y2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;y2&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;y2&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;y2&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">y</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;h&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">f_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="s1">&#39;h&#39;</span> <span class="ow">in</span> <span class="n">f_args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># Apply checks</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">if</span> <span class="n">x1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x1 must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x2 must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="k">if</span> <span class="n">y1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y1 must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">if</span> <span class="n">y2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y2 must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y must be non negative&#39;</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;w must be positive&#39;</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;h must be positive&#39;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">if</span> <span class="n">x1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="n">x2</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x2 must be bigger than x1&#39;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="k">if</span> <span class="n">y1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&gt;=</span> <span class="n">y2</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y2 must be bigger than y1&#39;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># Return</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.complete_at_least_one_anchor_per_bbox" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">complete_at_least_one_anchor_per_bbox</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">bboxes_index_with_no_positive</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Completes the dictionary of anchor to have at least one positive anchor per bbox if it is not
already the case.
If a bbox is not associated to an anchor, we associate it to the anchor with which it has
the biggest iou (if this anchor is not already associated with another bbox)
Args:
    anchor_boxes_dict (dict): Anchor boxes dictionary
        - 'anchor_img_coordinates': Coordinates of the anchor box (input format ie. image space)
        - 'bboxes': bboxes with their coordinates xyxy (in image space) and iou
        - 'anchor_type': anchor type (pos, neg or neutral)
        - 'anchor_validity': anchor validity
        - 'best_bbox_index': bbox associated to this anchor
    bboxes_index_with_no_positive (list): List of bboxes with no positive anchor associated
Returns:
    dict: Updated anchor boxes dictionary</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="k">def</span> <span class="nf">complete_at_least_one_anchor_per_bbox</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bboxes_index_with_no_positive</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Completes the dictionary of anchor to have at least one positive anchor per bbox if it is not</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">    already the case.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="sd">    If a bbox is not associated to an anchor, we associate it to the anchor with which it has</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a><span class="sd">    the biggest iou (if this anchor is not already associated with another bbox)</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a><span class="sd">        anchor_boxes_dict (dict): Anchor boxes dictionary</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="sd">            - &#39;anchor_img_coordinates&#39;: Coordinates of the anchor box (input format ie. image space)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="sd">            - &#39;bboxes&#39;: bboxes with their coordinates xyxy (in image space) and iou</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="sd">            - &#39;anchor_type&#39;: anchor type (pos, neg or neutral)</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a><span class="sd">            - &#39;anchor_validity&#39;: anchor validity</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a><span class="sd">            - &#39;best_bbox_index&#39;: bbox associated to this anchor</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a><span class="sd">        bboxes_index_with_no_positive (list): List of bboxes with no positive anchor associated</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a><span class="sd">        dict: Updated anchor boxes dictionary</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>    <span class="c1"># For each missing bbox ...</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="k">for</span> <span class="n">index_bbox</span> <span class="ow">in</span> <span class="n">bboxes_index_with_no_positive</span><span class="p">:</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="c1"># ... we look for the anchor box with the best iou ...</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="n">best_iou</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># We could set it to 0 but there exists rare case where all the anchor boxes have a 0 iou.</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>        <span class="n">best_anchor_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>            <span class="n">iou</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">index_bbox</span><span class="p">][</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>            <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">best_iou</span><span class="p">:</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>                <span class="n">best_iou</span> <span class="o">=</span> <span class="n">iou</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="n">best_anchor_idx</span> <span class="o">=</span> <span class="n">anchor_idx</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>        <span class="c1"># ... and we update this anchor if it is not already positive</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>        <span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">best_anchor_idx</span><span class="p">]</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>        <span class="k">if</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">and</span> <span class="n">best_iou</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_bbox</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>            <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">best_anchor_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span>  <span class="c1"># Update</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>    <span class="k">return</span> <span class="n">anchor_boxes_dict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.create_fake_dict_rois_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_fake_dict_rois_targets</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Creates fake dict_rois_targets in the rare cases where the function limit_rois_targets gives an empty object (None).</p>
<div class="highlight"><pre><span></span><code>Process : we return ROIs on the entire image, considered as background
</code></pre></div>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>img_data</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Metadata of the image after the preprocessing. In particular, the size of the image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subsampling_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Subsampling of the base model (shared layers)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nb_rois_per_img</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of fake ROIs to return</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: The dictionary of fake "selected" ROIs</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1285" name="__codelineno-0-1285"></a><span class="k">def</span> <span class="nf">create_fake_dict_rois_targets</span><span class="p">(</span><span class="n">img_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Creates fake dict_rois_targets in the rare cases where the function limit_rois_targets gives an empty object (None).</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a><span class="sd">        Process : we return ROIs on the entire image, considered as background</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a><span class="sd">        img_data (dict): Metadata of the image after the preprocessing. In particular, the size of the image</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a><span class="sd">        subsampling_ratio (int): Subsampling of the base model (shared layers)</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a><span class="sd">        nb_rois_per_img (int): Number of fake ROIs to return</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a><span class="sd">        dict: The dictionary of fake &quot;selected&quot; ROIs</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>    <span class="c1"># Get the size of the image in the features map</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>    <span class="n">height_img_in_feature_map</span><span class="p">,</span> <span class="n">width_img_in_feature_map</span> <span class="o">=</span> <span class="n">get_feature_map_size</span><span class="p">(</span><span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_height&#39;</span><span class="p">],</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_width&#39;</span><span class="p">],</span> <span class="n">subsampling_ratio</span><span class="p">)</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>    <span class="c1"># Create a dictionary with an unique entry : a ROI on the entire image, considered as background</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>    <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>        <span class="mi">0</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>            <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">width_img_in_feature_map</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">height_img_in_feature_map</span><span class="p">,</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>                            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">height_img_in_feature_map</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">width_img_in_feature_map</span><span class="p">},</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>            <span class="s1">&#39;classifier_regression_target&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>            <span class="s1">&#39;classifier_class_target&#39;</span><span class="p">:</span> <span class="s1">&#39;bg&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>        <span class="p">}</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>    <span class="p">}</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>    <span class="c1"># We clone this ROI to have as many as wanted</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a>    <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_rois_per_img</span><span class="p">)}</span>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>    <span class="k">return</span> <span class="n">dict_rois_targets</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">draw_bboxes</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt_bboxes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predicted_bboxes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Adds bboxes to an image (np.ndarray)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_img</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Input image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Kwargs:
    output_path (str): Path to the output file. If None, the result is not saved
    gt_bboxes (list): List of "ground truth" bboxes to display
        Each entry must be a dictionary with keys x1, y1, x2, y2 and (optional) class
    predicted_bboxes (list): List of bboxes coming from a prediction (same format as gt_bboxes)
Raises:
    FileExistsError: If the output file already exists
Returns:
    (np.ndarray) : The image with the boxes</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="k">def</span> <span class="nf">draw_bboxes</span><span class="p">(</span><span class="n">input_img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gt_bboxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="n">predicted_bboxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Adds bboxes to an image (np.ndarray)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        input_img (np.ndarray): Input image</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Kwargs:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        output_path (str): Path to the output file. If None, the result is not saved</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        gt_bboxes (list): List of &quot;ground truth&quot; bboxes to display</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            Each entry must be a dictionary with keys x1, y1, x2, y2 and (optional) class</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        predicted_bboxes (list): List of bboxes coming from a prediction (same format as gt_bboxes)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        FileExistsError: If the output file already exists</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        (np.ndarray) : The image with the boxes</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">if</span> <span class="n">gt_bboxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">gt_bboxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">if</span> <span class="n">predicted_bboxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">predicted_bboxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="c1"># Define colors</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="n">green</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="c1"># Create green rectangles for each bbox</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">gt_bboxes</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">draw_rectangle_from_bbox</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">green</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="c1"># Create red rectangles for each predicted bbox</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">predicted_bboxes</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">draw_rectangle_from_bbox</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">red</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">input_img</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image saved here : </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="k">return</span> <span class="n">input_img</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.draw_bboxes_from_file" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">draw_bboxes_from_file</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt_bboxes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">predicted_bboxes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Adds bboxes to an image from a file</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Path to the input image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Kwargs:
    output_path (str): Path to the output file. If None, the result is not saved
    gt_bboxes (list): List of "ground truth" bboxes to display
        Each entry must be a dictionary with keys x1, y1, x2, y2 and (optional) class
    predicted_bboxes (list): List of bboxes coming from a prediction (same format as gt_bboxes)
Raises:
    FileNotFoundError: If the input file does not exist
Returns:
    (np.ndarray) : The image with the boxes</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="k">def</span> <span class="nf">draw_bboxes_from_file</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gt_bboxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                          <span class="n">predicted_bboxes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Adds bboxes to an image from a file</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        input_path (str): Path to the input image</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    Kwargs:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        output_path (str): Path to the output file. If None, the result is not saved</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        gt_bboxes (list): List of &quot;ground truth&quot; bboxes to display</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            Each entry must be a dictionary with keys x1, y1, x2, y2 and (optional) class</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        predicted_bboxes (list): List of bboxes coming from a prediction (same format as gt_bboxes)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        FileNotFoundError: If the input file does not exist</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        (np.ndarray) : The image with the boxes</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_path</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="c1"># Load image</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">input_img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">return</span> <span class="n">draw_bboxes</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">gt_bboxes</span><span class="p">,</span> <span class="n">predicted_bboxes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.draw_rectangle_from_bbox" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">draw_rectangle_from_bbox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Draws a rectangle in the image and adds a text (optional)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>img</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The considered image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>bbox</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The dictionary containing the coordinates and the text</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>color</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A RGB tuple giving the color of the rectangle</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>thickness</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The thickness of the rectangle</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>with_center</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, also draws the center of the rectangle</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Raises:
    ValueError: If one of the keys 'x1', 'y1', 'x2', 'y2' is missing</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="k">def</span> <span class="nf">draw_rectangle_from_bbox</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                             <span class="n">thickness</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">with_center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Draws a rectangle in the image and adds a text (optional)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        img (np.ndarray): The considered image</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        bbox (dict): The dictionary containing the coordinates and the text</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        color (tuple): A RGB tuple giving the color of the rectangle</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        thickness (int): The thickness of the rectangle</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        with_center (bool): If True, also draws the center of the rectangle</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        ValueError: If one of the keys &#39;x1&#39;, &#39;y1&#39;, &#39;x2&#39;, &#39;y2&#39; is missing</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="c1"># Check mandatory keys</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bbox</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">]]):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One of the mandatory keys (&#39;x1&#39;, &#39;y1&#39;, &#39;x2&#39;, &#39;y2&#39;) is missing in the object bbox.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="c1"># Process</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="n">class_name</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="k">if</span> <span class="n">class_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">if</span> <span class="s1">&#39;proba&#39;</span> <span class="ow">in</span> <span class="n">bbox</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">proba</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;proba&#39;</span><span class="p">],</span> <span class="s2">&quot;.2f&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">proba</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">30</span><span class="p">),</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">if</span> <span class="n">with_center</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">center_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">center_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.format_classifier_inputs_and_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">format_classifier_inputs_and_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">,</span> <span class="n">dict_classes</span><span class="p">,</span> <span class="n">classifier_regr_scaling</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Transforms a dictionary of target ROIs into a suitable format for the classifier model</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dict_rois</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary containing the possible inputs / targets of the classifier</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dict_classes</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mapping of the classes of the model (must not contain 'bg'), format :  {idx: label}</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classifier_regr_scaling</code></td>
          <td>
                <code>list&lt;float&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Regression coefficient to apply to coordinates</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    np.ndarray: coordinates of each selected ROIs
        # Shape : (1, nb_rois, 4), format x, y, h, w
    np.ndarray: Classification target of the classifier (with the background)
        # Shape (1, nb_rois, (nb_classes + 1))
    np.ndarray: Two parts array:
        # Shape (1, nb_rois, 2 * nb_classes * 4)
        -&gt; First half : identification class ground truth to calculate the regression loss for the classifier
            # Shape (1, nb_rois, nb_classes * 4)
        -&gt; Second hald : regression target for the classifier (one regression per class)
            # Shape (1, nb_rois, nb_classes * 4)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span>
<span class="normal"><a href="#__codelineno-0-1333">1333</a></span>
<span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1314" name="__codelineno-0-1314"></a><span class="k">def</span> <span class="nf">format_classifier_inputs_and_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dict_classes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>                                         <span class="n">classifier_regr_scaling</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Transforms a dictionary of target ROIs into a suitable format for the classifier model</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a><span class="sd">        dict_rois (dict): Dictionary containing the possible inputs / targets of the classifier</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a><span class="sd">        dict_classes (dict): Mapping of the classes of the model (must not contain &#39;bg&#39;), format :  {idx: label}</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a><span class="sd">        classifier_regr_scaling (list&lt;float&gt;): Regression coefficient to apply to coordinates</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a><span class="sd">        np.ndarray: coordinates of each selected ROIs</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a><span class="sd">            # Shape : (1, nb_rois, 4), format x, y, h, w</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a><span class="sd">        np.ndarray: Classification target of the classifier (with the background)</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a><span class="sd">            # Shape (1, nb_rois, (nb_classes + 1))</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a><span class="sd">        np.ndarray: Two parts array:</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a><span class="sd">            # Shape (1, nb_rois, 2 * nb_classes * 4)</span>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a><span class="sd">            -&gt; First half : identification class ground truth to calculate the regression loss for the classifier</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a><span class="sd">                # Shape (1, nb_rois, nb_classes * 4)</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a><span class="sd">            -&gt; Second hald : regression target for the classifier (one regression per class)</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a><span class="sd">                # Shape (1, nb_rois, nb_classes * 4)</span>
<a id="__codelineno-0-1333" name="__codelineno-0-1333"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1334" name="__codelineno-0-1334"></a>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a>    <span class="c1"># Get the number of selected ROIs (the same for each image) and info on classes</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a>    <span class="n">nb_rois</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">)</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a>    <span class="n">nb_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_classes</span><span class="p">)</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>    <span class="n">class_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">name_class</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name_class</span> <span class="ow">in</span> <span class="n">dict_classes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a>    <span class="n">class_mapping</span><span class="p">[</span><span class="s1">&#39;bg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_mapping</span><span class="p">)</span>  <span class="c1"># Add background to the mapping</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a>    <span class="c1"># Init. of output arrays</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nb_rois</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># ROIs coordinates</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>    <span class="n">Y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nb_rois</span><span class="p">,</span> <span class="p">(</span><span class="n">nb_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># + 1 for background</span>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a>    <span class="n">Y2_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nb_rois</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">nb_classes</span><span class="p">))</span>  <span class="c1"># OHE class (without background), but repeated 4 times (one for each coordinate), will be used by the loss</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a>    <span class="n">Y2_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nb_rois</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">nb_classes</span><span class="p">))</span>  <span class="c1"># One regression per class (# TODO verify if we can&#39;t do only one regression)</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a>    <span class="c1"># For each ROI, we fill up the output arrays</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">roi_index</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>        <span class="c1">### ROI coordinates</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a>        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;w&#39;</span><span class="p">])</span>  <span class="c1"># Format x, y, h, w</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>        <span class="c1">### Targets of the classifier model</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a>        <span class="c1"># ROI class</span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a>        <span class="n">gt_class</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;classifier_class_target&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a>        <span class="n">idx_gt_class</span> <span class="o">=</span> <span class="n">class_mapping</span><span class="p">[</span><span class="n">gt_class</span><span class="p">]</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>        <span class="n">ohe_target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">nb_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a>        <span class="n">ohe_target</span><span class="p">[</span><span class="n">idx_gt_class</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># --&gt; e.g. [0, 1, 0] / 2 classes + &#39;bg&#39;</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a>        <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ohe_target</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>        <span class="c1"># ROI regression - loss target</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a>        <span class="n">ohe_target_no_bg</span> <span class="o">=</span> <span class="n">ohe_target</span><span class="p">[:</span><span class="n">nb_classes</span><span class="p">]</span>  <span class="c1"># We get rid of the background, no regression here --&gt; e.g. [0, 1]</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a>        <span class="n">ohe_target_no_bg_repeated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ohe_target_no_bg</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># We repeat the OHE targets four times 4 fois (one for each coordinate)</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a>        <span class="n">Y2_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ohe_target_no_bg_repeated</span>  <span class="c1"># e.g. [0, 0, 0, 0, 1, 1, 1, 1]</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>        <span class="c1"># ROI regression - regression - only if not background</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>        <span class="k">if</span> <span class="n">gt_class</span> <span class="o">!=</span> <span class="s1">&#39;bg&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>            <span class="n">target_regression</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="n">nb_classes</span> <span class="o">*</span> <span class="mi">4</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>            <span class="n">regression_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;classifier_regression_target&#39;</span><span class="p">],</span> <span class="n">classifier_regr_scaling</span><span class="p">)]</span>  <span class="c1"># Apply a scaling</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>            <span class="n">target_regression</span><span class="p">[</span><span class="n">idx_gt_class</span> <span class="o">*</span> <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="n">idx_gt_class</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">regression_values</span>  <span class="c1"># e.g. [0, 0, 0, 0, 0.2, -0.3, 0.1, 0.9]</span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>            <span class="n">Y2_2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">target_regression</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>    <span class="c1"># Concatenate Y2</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>    <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Y2_1</span><span class="p">,</span> <span class="n">Y2_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>    <span class="c1"># Add batch dimension</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>    <span class="n">Y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Y1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>    <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">Y2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>    <span class="c1"># Returns</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_all_viable_anchors_boxes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_all_viable_anchors_boxes</span><span class="p">(</span><span class="n">base_anchors</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">im_resized_height</span><span class="p">,</span> <span class="n">im_resized_width</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gets a dictionary of 'viable' anchor boxes.</p>
<p>From a list of "base" anchors, we will take each point of a features map, get its initial coordinates
(input of the model) and build as many anchors as "base" anchors with this point as a center.
Then we filter out the ones which are outside the image</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>base_anchors</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of base anchors</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subsampling_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Subsampling ratio of the shared model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>feature_map_height</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Height of the features map</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>feature_map_width</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Width of the features map</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>im_resized_height</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Height of the input image (preprocessed, without padding)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>im_resized_width</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Width of the input image (preprocessed, without padding)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict : set of 'viable' anchor boxes identified by (y, x, index_anchor)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-646" name="__codelineno-0-646"></a><span class="k">def</span> <span class="nf">get_all_viable_anchors_boxes</span><span class="p">(</span><span class="n">base_anchors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">subsampling_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">feature_map_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>                                 <span class="n">feature_map_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">im_resized_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">im_resized_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets a dictionary of &#39;viable&#39; anchor boxes.</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a><span class="sd">    From a list of &quot;base&quot; anchors, we will take each point of a features map, get its initial coordinates</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a><span class="sd">    (input of the model) and build as many anchors as &quot;base&quot; anchors with this point as a center.</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a><span class="sd">    Then we filter out the ones which are outside the image</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a><span class="sd">        base_anchors (list): List of base anchors</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a><span class="sd">        subsampling_ratio (int): Subsampling ratio of the shared model</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="sd">        feature_map_height (int): Height of the features map</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="sd">        feature_map_width (int): Width of the features map</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">        im_resized_height (int): Height of the input image (preprocessed, without padding)</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a><span class="sd">        im_resized_width (int): Width of the input image (preprocessed, without padding)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="sd">        dict : set of &#39;viable&#39; anchor boxes identified by (y, x, index_anchor)</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>    <span class="n">viable_anchor_boxes</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>    <span class="c1"># For each anchor...</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>    <span class="k">for</span> <span class="n">index_anchor</span><span class="p">,</span> <span class="p">(</span><span class="n">height_anchor</span><span class="p">,</span> <span class="n">width_anchor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base_anchors</span><span class="p">):</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="c1"># For each point of the features map...</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>        <span class="k">for</span> <span class="n">x_feature_map</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_map_width</span><span class="p">):</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>            <span class="c1"># x coordinate of the anchor, input format (ie in image space)</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>            <span class="n">x1_anchor</span> <span class="o">=</span> <span class="n">subsampling_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_feature_map</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">width_anchor</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># center - width / 2</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>            <span class="n">x2_anchor</span> <span class="o">=</span> <span class="n">subsampling_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_feature_map</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">width_anchor</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># center + width / 2</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>            <span class="c1"># We do not consider the anchors outside the image (before padding)</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>            <span class="k">if</span> <span class="n">x1_anchor</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x2_anchor</span> <span class="o">&gt;=</span> <span class="n">im_resized_width</span><span class="p">:</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>                <span class="k">continue</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>            <span class="k">for</span> <span class="n">y_feature_map</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">feature_map_height</span><span class="p">):</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>                <span class="c1"># y coordinate of the anchor, input format (ie in image space)</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>                <span class="n">y1_anchor</span> <span class="o">=</span> <span class="n">subsampling_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_feature_map</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">height_anchor</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># center - height / 2</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>                <span class="n">y2_anchor</span> <span class="o">=</span> <span class="n">subsampling_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_feature_map</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">height_anchor</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># center + height / 2</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>                <span class="c1"># We do not consider the anchors outside the image (before padding)</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>                <span class="k">if</span> <span class="n">y1_anchor</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y2_anchor</span> <span class="o">&gt;=</span> <span class="n">im_resized_height</span><span class="p">:</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>                <span class="c1"># We update the dictionary of the &#39;viable&#39; anchor boxes (y, x, anchor)</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>                <span class="n">id_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_feature_map</span><span class="p">,</span> <span class="n">x_feature_map</span><span class="p">,</span> <span class="n">index_anchor</span><span class="p">)</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>                <span class="n">viable_anchor_boxes</span><span class="p">[</span><span class="n">id_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>                    <span class="s1">&#39;anchor_img_coordinates&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">x1_anchor</span><span class="p">,</span> <span class="n">y1_anchor</span><span class="p">,</span> <span class="n">x2_anchor</span><span class="p">,</span> <span class="n">y2_anchor</span><span class="p">)</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>                <span class="p">}</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>    <span class="c1"># Check errors</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viable_anchor_boxes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No viable bbox for one of the input images.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The size of the preprocessed images may be too small when compared to the list of anchors of the model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No viable bbox for one of the input images.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="k">return</span> <span class="n">viable_anchor_boxes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_area_from_xyxy" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_area_from_xyxy</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the area (absolute, not relative) of a rectangle in opposite points format</p>

<details class="args-" open>
  <summary>Args</summary>
  <p>x1 (float): x coordinate of the upper left point
y1 (float): y coordinate of the upper left point
x2 (float): x coordinate of the bottom right point
y2 (float): y coordinate of the bottom right point</p>
</details>


  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>float</code></td>          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The absolute area of the rectangle</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="nd">@check_coordinates_validity</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="k">def</span> <span class="nf">get_area_from_xyxy</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the area (absolute, not relative) of a rectangle in opposite points format</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    Args :</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        x1 (float): x coordinate of the upper left point</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        y1 (float): y coordinate of the upper left point</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        x2 (float): x coordinate of the bottom right point</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">        y2 (float): y coordinate of the bottom right point</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        float : The absolute area of the rectangle</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="k">return</span> <span class="nb">abs</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_test_inputs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_classifier_test_inputs</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Formats the inputs for the classifier from ROIs proposed by the RPN (test case)</p>
<p>Process : For each ROI, we simply get the format x, y, h, w</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>rois_coordinates</code></td>
          <td>
                <code>list&lt;np.ndarray&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>ROIs to transform
rois_coordinates must be a list with only one entry : the ROIs of the current image (for prediction, the batch_size is forced to 1)
The unique entry is a numpy array:
    # Shape (nb_rois, 4)
    # Format x1, y1, x2, y2</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Raises:
    ValueError: If the number of elements in the list is different from 1
Returns:
    np.ndarray : ROIs to use as inputs of the model
        # Shape : (1, nb_rois, 4), format x, y, h, w</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1387" name="__codelineno-0-1387"></a><span class="k">def</span> <span class="nf">get_classifier_test_inputs</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Formats the inputs for the classifier from ROIs proposed by the RPN (test case)</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a><span class="sd">    Process : For each ROI, we simply get the format x, y, h, w</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a><span class="sd">        rois_coordinates (list&lt;np.ndarray&gt;): ROIs to transform</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a><span class="sd">            rois_coordinates must be a list with only one entry : the ROIs of the current image (for prediction, the batch_size is forced to 1)</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a><span class="sd">            The unique entry is a numpy array:</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a><span class="sd">                # Shape (nb_rois, 4)</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a><span class="sd">                # Format x1, y1, x2, y2</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a><span class="sd">        ValueError: If the number of elements in the list is different from 1</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a><span class="sd">        np.ndarray : ROIs to use as inputs of the model</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="sd">            # Shape : (1, nb_rois, 4), format x, y, h, w</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In prediction mode, the batch_size must be 1.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>    <span class="c1"># Init. of the output array</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>    <span class="n">nb_rois</span> <span class="o">=</span> <span class="n">rois_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>    <span class="n">output_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb_rois</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>    <span class="c1"># We process ROIs one at a time</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>        <span class="c1"># Get format x, y, h, w</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">xyxy_to_xyhw</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>        <span class="c1"># Update output array</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a>        <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>    <span class="c1"># Return result</span>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>    <span class="k">return</span> <span class="n">X</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_classifier_train_inputs_and_targets</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">,</span> <span class="n">rois_coordinates</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the regression and classification of the classifier from the ROIs given by the RPN</p>

<details class="process-" open>
  <summary>We got the ROIs from the RPN prediction (and transformed them via get_roi_from_rpn_predictions)</summary>
  <p>For each image we will :
- Calculate the ious between bboxes and ROIs
- Keep, for each ROI, the bbox with the biggest iou (if the iou is bigger than a threshold)
- Filter the ROIs to only some of them:
    - Allows to keep OOM in check
    - We respect to the loss, we will, of course, only take into account the selected ROIs
    - We will keep a balance between positive ROIs (match with an object) and negative ROIs (match with 'bg')
- Format the inputs and targets of the model</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code>ModelKerasFasterRcnnObjectDetector</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model used (contains all the necessary configs)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_data_batch</code></td>
          <td>
                <code>list&lt;dict&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of img_data for the batch
Used here to get the bboxes of the images to define the targets of the classifier</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rois_coordinates</code></td>
          <td>
                <code>list&lt;np.ndarray&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Final list of the ROIs selected for the classifier part.
Each element is a numpy array containing the coordinates of the ROIs calculated for an image of the batch</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.get_classifier_train_inputs_and_targets--format-x1-y1-x2-y2-opposite-points">Format x1, y1, x2, y2 (opposite points)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    np.ndarray : ROIs coordinates in input of the model - Format x, y, h, w
        # Shape : (batch_size, nb_rois_per_img, 4), format x, y, h, w
    np.ndarray : Targets of the classifier - classification
        # Shape (batch_size, nb_rois_per_img, (nb_classes + 1))
    np.ndarray : Targets of the classifier - regression
        # Shape (batch_size, nb_rois_per_img, 2 * nb_classes * 4)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1077" name="__codelineno-0-1077"></a><span class="k">def</span> <span class="nf">get_classifier_train_inputs_and_targets</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>                                            <span class="n">rois_coordinates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the regression and classification of the classifier from the ROIs given by the RPN</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a><span class="sd">    Process : We got the ROIs from the RPN prediction (and transformed them via get_roi_from_rpn_predictions)</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a><span class="sd">              For each image we will :</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a><span class="sd">              - Calculate the ious between bboxes and ROIs</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a><span class="sd">              - Keep, for each ROI, the bbox with the biggest iou (if the iou is bigger than a threshold)</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a><span class="sd">              - Filter the ROIs to only some of them:</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a><span class="sd">                  - Allows to keep OOM in check</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a><span class="sd">                  - We respect to the loss, we will, of course, only take into account the selected ROIs</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a><span class="sd">                  - We will keep a balance between positive ROIs (match with an object) and negative ROIs (match with &#39;bg&#39;)</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a><span class="sd">              - Format the inputs and targets of the model</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a><span class="sd">        model (ModelKerasFasterRcnnObjectDetector): Model used (contains all the necessary configs)</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a><span class="sd">        img_data_batch (list&lt;dict&gt;): List of img_data for the batch</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a><span class="sd">            Used here to get the bboxes of the images to define the targets of the classifier</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a><span class="sd">        rois_coordinates (list&lt;np.ndarray&gt;): Final list of the ROIs selected for the classifier part.</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a><span class="sd">            Each element is a numpy array containing the coordinates of the ROIs calculated for an image of the batch</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a><span class="sd">            # Format x1, y1, x2, y2 (opposite points)</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a><span class="sd">        np.ndarray : ROIs coordinates in input of the model - Format x, y, h, w</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a><span class="sd">            # Shape : (batch_size, nb_rois_per_img, 4), format x, y, h, w</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a><span class="sd">        np.ndarray : Targets of the classifier - classification</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a><span class="sd">            # Shape (batch_size, nb_rois_per_img, (nb_classes + 1))</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a><span class="sd">        np.ndarray : Targets of the classifier - regression</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a><span class="sd">            # Shape (batch_size, nb_rois_per_img, 2 * nb_classes * 4)</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>    <span class="c1"># Get model attributes</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>    <span class="n">subsampling_ratio</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shared_model_subsampling</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>    <span class="n">classifier_min_overlap</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">classifier_min_overlap</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>    <span class="n">classifier_max_overlap</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">classifier_max_overlap</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>    <span class="n">nb_rois_per_img</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nb_rois_classifier</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>    <span class="n">classifier_regr_scaling</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">classifier_regr_scaling</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>    <span class="n">dict_classes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">dict_classes</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>    <span class="c1"># Init. of output arrays</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>    <span class="n">X</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>    <span class="c1"># Preprocess one image at a time</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>    <span class="k">for</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">rois</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">img_data_batch</span><span class="p">,</span> <span class="n">rois_coordinates</span><span class="p">):</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>        <span class="c1"># Get all the ious betwee, ROIs and bboxes</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>        <span class="n">dict_rois</span> <span class="o">=</span> <span class="n">get_rois_bboxes_iou</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">)</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>        <span class="c1"># Find the best bbox for each ROI et the corresponding regression</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>        <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="n">get_rois_targets</span><span class="p">(</span><span class="n">dict_rois</span><span class="p">,</span> <span class="n">classifier_min_overlap</span><span class="p">,</span> <span class="n">classifier_max_overlap</span><span class="p">)</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>        <span class="c1"># Limit the number of ROI</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>        <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="n">limit_rois_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">)</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>        <span class="c1"># If we have no more targets (very rare !), we consider the entire image as &#39;bg&#39;</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>        <span class="k">if</span> <span class="n">dict_rois_targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There is an image with no suitable target for the classifier. We consider the entire image as background.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>            <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="n">create_fake_dict_rois_targets</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">)</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>        <span class="c1"># Format the classification and regression targets</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>        <span class="n">X_tmp</span><span class="p">,</span> <span class="n">Y1_tmp</span><span class="p">,</span> <span class="n">Y2_tmp</span> <span class="o">=</span> <span class="n">format_classifier_inputs_and_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">,</span> <span class="n">dict_classes</span><span class="p">,</span> <span class="n">classifier_regr_scaling</span><span class="p">)</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>        <span class="c1"># Increment output</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>            <span class="n">X</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="n">X_tmp</span><span class="p">,</span> <span class="n">Y1_tmp</span><span class="p">,</span> <span class="n">Y2_tmp</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>            <span class="c1"># TODO : get rid of the concatenate in the loop and concatenate a list one time at the end instead (much faster)</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">X_tmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>            <span class="n">Y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y1</span><span class="p">,</span> <span class="n">Y1_tmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>            <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Y2</span><span class="p">,</span> <span class="n">Y2_tmp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>    <span class="c1"># We return the result</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_feature_map_size" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_feature_map_size</span><span class="p">(</span><span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the size of the features map given the height and width of the image using
the subsampling_ratio of the shared model. For exemple, for VGG16, the subsampling_ratio is 16</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_height</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Height of the image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_width</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Width of the image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subsampling_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Subsampling ratio of the shared model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Raises:
    ValueError: If incorrect dimension of the image (&lt; 1)
    ValueError: If the subsampling_ratio is incorrect (&lt; 1)
Returns:
    int: Height of the features map
    int: Width of the features map</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="k">def</span> <span class="nf">get_feature_map_size</span><span class="p">(</span><span class="n">input_height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">input_width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the size of the features map given the height and width of the image using</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    the subsampling_ratio of the shared model. For exemple, for VGG16, the subsampling_ratio is 16</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">        input_height (int): Height of the image</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="sd">        input_width (int): Width of the image</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        subsampling_ratio (int): Subsampling ratio of the shared model</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="sd">        ValueError: If incorrect dimension of the image (&lt; 1)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        ValueError: If the subsampling_ratio is incorrect (&lt; 1)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        int: Height of the features map</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        int: Width of the features map</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="c1"># Manage errors</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="k">if</span> <span class="n">input_height</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">input_width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad image shape (H : </span><span class="si">{</span><span class="n">input_height</span><span class="si">}</span><span class="s2"> / W : </span><span class="si">{</span><span class="n">input_width</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="k">if</span> <span class="n">subsampling_ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bad subsampling ratio (</span><span class="si">{</span><span class="n">subsampling_ratio</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="c1"># Process</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="k">return</span> <span class="n">input_height</span> <span class="o">//</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">input_width</span> <span class="o">//</span> <span class="n">subsampling_ratio</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_final_bboxes</span><span class="p">(</span><span class="n">final_boxes</span><span class="p">,</span> <span class="n">img_data</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Resizes the final predicted boxes to image space and formats them.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>final_boxes</code></td>
          <td>
                <code>list) </code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>list of boxes valid from a probability AND coordinates xyxy points of view and with "no" overlap</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.get_final_bboxes--format-cl-proba-coordinates">Format [(cl, proba, coordinates), (...), ...)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_data</code></td>
          <td>
                <code>dict) </code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Metadata associated with the image (used to resize predictions)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    A list of bboxes corresponding to the model predictions</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1520" name="__codelineno-0-1520"></a><span class="k">def</span> <span class="nf">get_final_bboxes</span><span class="p">(</span><span class="n">final_boxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">img_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Resizes the final predicted boxes to image space and formats them.</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a><span class="sd">        final_boxes (list) : list of boxes valid from a probability AND coordinates xyxy points of view and with &quot;no&quot; overlap</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a><span class="sd">            # Format [(cl, proba, coordinates), (...), ...)</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a><span class="sd">        img_data (dict) : Metadata associated with the image (used to resize predictions)</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a><span class="sd">        A list of bboxes corresponding to the model predictions</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>    <span class="n">list_bboxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>    <span class="n">resized_width</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_width&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>    <span class="n">original_width</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;original_width&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>    <span class="n">resized_height</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_height&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>    <span class="n">original_height</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;original_height&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>    <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">proba</span><span class="p">,</span> <span class="n">coordinates</span> <span class="ow">in</span> <span class="n">final_boxes</span><span class="p">:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>        <span class="n">bbox</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;proba&#39;</span><span class="p">:</span> <span class="n">proba</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>                <span class="s1">&#39;y1&#39;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>        <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_width</span> <span class="o">/</span> <span class="n">resized_width</span><span class="p">))</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>        <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_width</span> <span class="o">/</span> <span class="n">resized_width</span><span class="p">))</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>        <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_height</span> <span class="o">/</span> <span class="n">resized_height</span><span class="p">))</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>        <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">original_height</span> <span class="o">/</span> <span class="n">resized_height</span><span class="p">))</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>        <span class="n">list_bboxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bbox</span><span class="p">))</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>    <span class="k">return</span> <span class="n">list_bboxes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_iou" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_iou</span><span class="p">(</span><span class="n">coordinatesA</span><span class="p">,</span> <span class="n">coordinatesB</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the intersection over union (iou) from the coordinates of two
rectangles (in opposite points format)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>coordinatesA</code></td>
          <td>
                <code>tuple&lt;float&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The coordinates of the first rectangle in the format (x1, y1, x2, y2)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>coordinatesB</code></td>
          <td>
                <code>tuple&lt;float&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The coordinates of the second rectangle in the format (x1, y1, x2, y2)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    float: Intersection over union of the two rectangles</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="k">def</span> <span class="nf">get_iou</span><span class="p">(</span><span class="n">coordinatesA</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">coordinatesB</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the intersection over union (iou) from the coordinates of two</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    rectangles (in opposite points format)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">        coordinatesA (tuple&lt;float&gt;): The coordinates of the first rectangle in the format (x1, y1, x2, y2)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        coordinatesB (tuple&lt;float&gt;): The coordinates of the second rectangle in the format (x1, y1, x2, y2)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="sd">        float: Intersection over union of the two rectangles</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="c1"># Get areas of A and B</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">areaA</span> <span class="o">=</span> <span class="n">get_area_from_xyxy</span><span class="p">(</span><span class="o">*</span><span class="n">coordinatesA</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">areaB</span> <span class="o">=</span> <span class="n">get_area_from_xyxy</span><span class="p">(</span><span class="o">*</span><span class="n">coordinatesB</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="c1"># If any null, iou is equal to 0</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">if</span> <span class="n">areaA</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">areaB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="n">x1A</span><span class="p">,</span> <span class="n">y1A</span><span class="p">,</span> <span class="n">x2A</span><span class="p">,</span> <span class="n">y2A</span> <span class="o">=</span> <span class="n">coordinatesA</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="n">x1B</span><span class="p">,</span> <span class="n">y1B</span><span class="p">,</span> <span class="n">x2B</span><span class="p">,</span> <span class="n">y2B</span> <span class="o">=</span> <span class="n">coordinatesB</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="c1"># Get coordinates of the intersection</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">x1_inter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1A</span><span class="p">,</span> <span class="n">x1B</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="n">y1_inter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1A</span><span class="p">,</span> <span class="n">y1B</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="n">x2_inter</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x2A</span><span class="p">,</span> <span class="n">x2B</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="n">y2_inter</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y2A</span><span class="p">,</span> <span class="n">y2B</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="c1"># Get intersection area</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="k">if</span> <span class="n">x2_inter</span> <span class="o">&gt;</span> <span class="n">x1_inter</span> <span class="ow">and</span> <span class="n">y2_inter</span> <span class="o">&gt;</span> <span class="n">y1_inter</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">area_inter</span> <span class="o">=</span> <span class="n">get_area_from_xyxy</span><span class="p">(</span><span class="n">x1_inter</span><span class="p">,</span> <span class="n">y1_inter</span><span class="p">,</span> <span class="n">x2_inter</span><span class="p">,</span> <span class="n">y2_inter</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">area_inter</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="c1"># Return IOU</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="k">return</span> <span class="n">area_inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">areaA</span> <span class="o">+</span> <span class="n">areaB</span> <span class="o">-</span> <span class="n">area_inter</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_iou_anchors_bboxes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_iou_anchors_bboxes</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the iou for each anchor boxes with all the bboxes of a list (for example, all the
bboxes of an image)</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>anchor_boxes_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Anchor boxes dictionary
- 'anchor_img_coordinates': xyxy coordinates of the anchor boxe (input format, ie. image space)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>image_bboxes</code></td>
          <td>
                <code>list&lt;dict&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of bboxes</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: The input dictionary to which we added a bboxes field containing coordinates and iou</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-696" name="__codelineno-0-696"></a><span class="k">def</span> <span class="nf">get_iou_anchors_bboxes</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the iou for each anchor boxes with all the bboxes of a list (for example, all the</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a><span class="sd">    bboxes of an image)</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a><span class="sd">        anchor_boxes_dict (dict): Anchor boxes dictionary</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a><span class="sd">            - &#39;anchor_img_coordinates&#39;: xyxy coordinates of the anchor boxe (input format, ie. image space)</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a><span class="sd">        image_bboxes (list&lt;dict&gt;): List of bboxes</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a><span class="sd">        dict: The input dictionary to which we added a bboxes field containing coordinates and iou</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>    <span class="c1"># For each anchor ...</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>    <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>        <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>        <span class="n">anchor_img_coordinates</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_img_coordinates&#39;</span><span class="p">]</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>        <span class="c1"># ... and for each bbox in the list ...</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>        <span class="k">for</span> <span class="n">index_bbox</span><span class="p">,</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_bboxes</span><span class="p">):</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>            <span class="c1"># ... we calculate the iou and add the info to the dictionary of anchors</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>            <span class="n">bbox_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">])</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>            <span class="n">iou</span> <span class="o">=</span> <span class="n">get_iou</span><span class="p">(</span><span class="n">anchor_img_coordinates</span><span class="p">,</span> <span class="n">bbox_coordinates</span><span class="p">)</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">index_bbox</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>                <span class="s1">&#39;iou&#39;</span><span class="p">:</span> <span class="n">iou</span><span class="p">,</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>                <span class="s1">&#39;bbox_img_coordinates&#39;</span><span class="p">:</span> <span class="n">bbox_coordinates</span><span class="p">,</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>            <span class="p">}</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>        <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>    <span class="k">return</span> <span class="n">anchor_boxes_dict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_new_img_size_from_min_side_size" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_new_img_size_from_min_side_size</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">img_min_side_size</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gets the new dimensions of an image so that the smaller dimension is equal to img_min_side_size
but keeping the ratio.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>height</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Height of the base image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>width</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Width of the base image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Kwargs:
    img_min_side_size (int): Final size of the smaller dimension
Raises:
    ValueError: If incorrect dimension of the image (&lt; 1)
    ValueError: If img_min_side_size is incorrect (&lt; 1)
Returns:
    int: Resized height
    int: Resized width</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="k">def</span> <span class="nf">get_new_img_size_from_min_side_size</span><span class="p">(</span><span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">img_min_side_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gets the new dimensions of an image so that the smaller dimension is equal to img_min_side_size</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">    but keeping the ratio.</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        height (int): Height of the base image</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        width (int): Width of the base image</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">    Kwargs:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">        img_min_side_size (int): Final size of the smaller dimension</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        ValueError: If incorrect dimension of the image (&lt; 1)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">        ValueError: If img_min_side_size is incorrect (&lt; 1)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">        int: Resized height</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        int: Resized width</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="c1"># Manage errors</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incorrect dimension of the image (H : </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2"> / W : </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="k">if</span> <span class="n">img_min_side_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimal size wanted incorrect (</span><span class="si">{</span><span class="n">img_min_side_size</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="c1"># Width smaller than height, we calculates the new height and set the width to img_min_side_size</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">img_min_side_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">resized_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">height</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">resized_width</span> <span class="o">=</span> <span class="n">img_min_side_size</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>    <span class="c1"># Height smaller than width, we calculates the new width and set the height to img_min_side_size</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">img_min_side_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">resized_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">resized_height</span> <span class="o">=</span> <span class="n">img_min_side_size</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>    <span class="k">return</span> <span class="n">resized_height</span><span class="p">,</span> <span class="n">resized_width</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_roi_from_rpn_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">,</span> <span class="n">rpn_predictions_cls</span><span class="p">,</span> <span class="n">rpn_predictions_regr</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Converts the output layers of the RPN (classification and regression) in ROIs</p>

<details class="process-" open>
  <summary>We get the prediction results of the RPN and we want to select regions of interest (ROIs) for the</summary>
  <p>classifier part. For each point and each base anchor, we apply the results of the regression. Then
we crop the resulting ROIs in order to stay in the limit of the image. Then we delete the unsuitable
ROIs (ie. invalid) and finally we apply a Non Max Suppression (NMS) algorithm to remove the ROIs
which overlap too much.</p>
</details>      <p>Note : We work with float coordinates. It is no big deal, we will recast them to int to display them.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code>ModelKerasFasterRcnnObjectDetector</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model used (contains all the necessary configs)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_data_batch</code></td>
          <td>
                <code>list&lt;dict&gt;</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of img_data of the batch
Here, it is used to get the (preprocessed) size of the images in order to remove the ROIs which
are outside the image.
Each entry must contain 'resized_height' &amp; 'resized_width'</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rpn_predictions_cls</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Classification prediction (output RPN)</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-nb_anchor">shape: (batch_size, height_feature_map, width_feature_map, nb_anchor)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rpn_predictions_regr</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Regression prediction (output RPN)</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.get_roi_from_rpn_predictions--shape-batch_size-height_feature_map-width_feature_map-4-nb_anchor">shape: (batch_size, height_feature_map, width_feature_map, 4 * nb_anchor)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    list<np.ndarray> : Final ROIs list selected for the classifier part (coordinates in features map space)
        Each element is a numpy array of the ROIs coordinates calculated for an image of the batch (variable number).
        The coordinates are returned as int (whereas they were float as output of the RPN)
        # Format x1, y1, x2, y2
        Note : We can't return a numpy array because there are not the same number of ROIs for each image,
               thus, we return a list</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span>
<span class="normal"><a href="#__codelineno-0-957">957</a></span>
<span class="normal"><a href="#__codelineno-0-958">958</a></span>
<span class="normal"><a href="#__codelineno-0-959">959</a></span>
<span class="normal"><a href="#__codelineno-0-960">960</a></span>
<span class="normal"><a href="#__codelineno-0-961">961</a></span>
<span class="normal"><a href="#__codelineno-0-962">962</a></span>
<span class="normal"><a href="#__codelineno-0-963">963</a></span>
<span class="normal"><a href="#__codelineno-0-964">964</a></span>
<span class="normal"><a href="#__codelineno-0-965">965</a></span>
<span class="normal"><a href="#__codelineno-0-966">966</a></span>
<span class="normal"><a href="#__codelineno-0-967">967</a></span>
<span class="normal"><a href="#__codelineno-0-968">968</a></span>
<span class="normal"><a href="#__codelineno-0-969">969</a></span>
<span class="normal"><a href="#__codelineno-0-970">970</a></span>
<span class="normal"><a href="#__codelineno-0-971">971</a></span>
<span class="normal"><a href="#__codelineno-0-972">972</a></span>
<span class="normal"><a href="#__codelineno-0-973">973</a></span>
<span class="normal"><a href="#__codelineno-0-974">974</a></span>
<span class="normal"><a href="#__codelineno-0-975">975</a></span>
<span class="normal"><a href="#__codelineno-0-976">976</a></span>
<span class="normal"><a href="#__codelineno-0-977">977</a></span>
<span class="normal"><a href="#__codelineno-0-978">978</a></span>
<span class="normal"><a href="#__codelineno-0-979">979</a></span>
<span class="normal"><a href="#__codelineno-0-980">980</a></span>
<span class="normal"><a href="#__codelineno-0-981">981</a></span>
<span class="normal"><a href="#__codelineno-0-982">982</a></span>
<span class="normal"><a href="#__codelineno-0-983">983</a></span>
<span class="normal"><a href="#__codelineno-0-984">984</a></span>
<span class="normal"><a href="#__codelineno-0-985">985</a></span>
<span class="normal"><a href="#__codelineno-0-986">986</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-895" name="__codelineno-0-895"></a><span class="k">def</span> <span class="nf">get_roi_from_rpn_predictions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">rpn_predictions_cls</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>                                 <span class="n">rpn_predictions_regr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Converts the output layers of the RPN (classification and regression) in ROIs</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="sd">    Process : We get the prediction results of the RPN and we want to select regions of interest (ROIs) for the</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a><span class="sd">              classifier part. For each point and each base anchor, we apply the results of the regression. Then</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a><span class="sd">              we crop the resulting ROIs in order to stay in the limit of the image. Then we delete the unsuitable</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="sd">              ROIs (ie. invalid) and finally we apply a Non Max Suppression (NMS) algorithm to remove the ROIs</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a><span class="sd">              which overlap too much.</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="sd">    Note : We work with float coordinates. It is no big deal, we will recast them to int to display them.</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">        model (ModelKerasFasterRcnnObjectDetector): Model used (contains all the necessary configs)</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="sd">        img_data_batch (list&lt;dict&gt;): List of img_data of the batch</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a><span class="sd">            Here, it is used to get the (preprocessed) size of the images in order to remove the ROIs which</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">            are outside the image.</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">            Each entry must contain &#39;resized_height&#39; &amp; &#39;resized_width&#39;</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">        rpn_predictions_cls (np.ndarray): Classification prediction (output RPN)</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">            # shape: (batch_size, height_feature_map, width_feature_map, nb_anchor)</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a><span class="sd">        rpn_predictions_regr (np.ndarray): Regression prediction (output RPN)</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="sd">            # shape: (batch_size, height_feature_map, width_feature_map, 4 * nb_anchor)</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">        list&lt;np.ndarray&gt; : Final ROIs list selected for the classifier part (coordinates in features map space)</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">            Each element is a numpy array of the ROIs coordinates calculated for an image of the batch (variable number).</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">            The coordinates are returned as int (whereas they were float as output of the RPN)</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="sd">            # Format x1, y1, x2, y2</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a><span class="sd">            Note : We can&#39;t return a numpy array because there are not the same number of ROIs for each image,</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a><span class="sd">                   thus, we return a list</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>    <span class="c1"># Get model attributes and info from the input shapes</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>    <span class="n">rpn_regr_scaling</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn_regr_scaling</span>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>    <span class="n">subsampling_ratio</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shared_model_subsampling</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>    <span class="n">base_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">list_anchors</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>    <span class="n">nb_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nb_anchors</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>    <span class="n">roi_nms_overlap_threshold</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_nms_overlap_threshold</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>    <span class="n">nms_max_boxes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nms_max_boxes</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>    <span class="n">batch_size</span><span class="p">,</span> <span class="n">height_feature_map</span><span class="p">,</span> <span class="n">width_feature_map</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rpn_predictions_cls</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="c1"># First we unscale the regression prediction (we scaled the target of the RPN)</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>    <span class="n">rpn_predictions_regr</span> <span class="o">=</span> <span class="n">rpn_predictions_regr</span> <span class="o">/</span> <span class="n">rpn_regr_scaling</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>    <span class="c1"># We get the base anchor base in features map space</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>    <span class="n">base_anchors_feature_maps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">subsampling_ratio</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">base_anchors</span><span class="p">]</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>    <span class="c1"># First we get all the possible anchor boxes on the features map</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>    <span class="c1"># ie., for each point and each base anchor, we get the coordinates of the anchor box centered on the point</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>    <span class="c1"># TODO : check if the + 0.5 are necessary</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>    <span class="n">anchor_on_feature_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>        <span class="p">[</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>            <span class="p">[</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>                <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">width_anchor</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">height_anchor</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_anchor</span><span class="p">,</span> <span class="n">width_anchor</span><span class="p">)</span> <span class="k">for</span> <span class="n">height_anchor</span><span class="p">,</span> <span class="n">width_anchor</span> <span class="ow">in</span> <span class="n">base_anchors_feature_maps</span><span class="p">]</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_feature_map</span><span class="p">)</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>            <span class="p">]</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height_feature_map</span><span class="p">)</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>        <span class="p">]</span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>    <span class="p">])</span>  <span class="c1"># Format (batch_size, height, width, nb_anchors, nb_coords (format xyhw -&gt; 4))</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>    <span class="c1"># Then we apply the regression result to these anchors</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>    <span class="c1"># First we put together the coordinates of the anchor box and the regression next to each other for each point /anchor box /image</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>    <span class="c1"># Format (batch_size, height, width, nb_anchors, 8 (x_anc, y_anc, h_anc, w_anc, tx, ty, th, tw))</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>    <span class="c1"># Note : first we reshape the regression where the results of each anchors were concatenated</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>    <span class="n">rpn_predictions_regr</span> <span class="o">=</span> <span class="n">rpn_predictions_regr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">height_feature_map</span><span class="p">,</span> <span class="n">width_feature_map</span><span class="p">,</span> <span class="n">nb_anchors</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>    <span class="n">concatenation_anchor_regr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">anchor_on_feature_maps</span><span class="p">,</span> <span class="n">rpn_predictions_regr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>    <span class="c1"># Then we apply the regression for each entry and obtain the candidate ROIs</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>    <span class="c1"># Format (batch_size, height, width, nb_anchors, 4 (x_roi, y_roi, h_roi, w_roi))</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>    <span class="n">rois_on_feature_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">func1d</span><span class="o">=</span><span class="n">apply_regression</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">concatenation_anchor_regr</span><span class="p">)</span>  <span class="c1"># Format x, y, h, w</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>    <span class="c1"># Then we crop the ROIs to stay inside the image</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>    <span class="c1"># Problem : in a batch, we padded the images so that they all have the same size,</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>    <span class="c1">#           and we want to crop the ROIs with respect to the initial size (unpadded)</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>    <span class="c1"># Solution : We apply same trick as before, ie. we put the limit size of each image after the coordinates of the associated ROIs</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>    <span class="n">feature_map_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_feature_map_size</span><span class="p">(</span><span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_height&#39;</span><span class="p">],</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_width&#39;</span><span class="p">],</span> <span class="n">subsampling_ratio</span><span class="p">)</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>                                  <span class="k">for</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="n">img_data_batch</span><span class="p">])</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>    <span class="n">array_img_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">feature_map_sizes</span><span class="p">,</span> <span class="p">(</span><span class="n">height_feature_map</span><span class="p">,</span> <span class="n">width_feature_map</span><span class="p">,</span> <span class="n">nb_anchors</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>    <span class="n">array_img_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">array_img_size</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># Format (batch_size, height, width, nb_anchors, 2)</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>    <span class="n">rois_on_feature_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">rois_on_feature_maps</span><span class="p">,</span> <span class="n">array_img_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># We add the sizes to the coordinates</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>    <span class="c1"># We do some work on ROI coordinates</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>    <span class="c1"># Format (batch_size, height, width, nb_anchors, 4 (x_roi, y_roi, h_roi, w_roi))</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>    <span class="n">rois_on_feature_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">func1d</span><span class="o">=</span><span class="n">restrict_and_convert_roi_boxes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">rois_on_feature_maps</span><span class="p">)</span>   <span class="c1"># Format x1, y1, x2, y2</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>    <span class="c1"># Reshape the ROIs in order to have (batch_size, nb_rois, 4), nb_rois = height_feature_map * width_feature_map * nb_anchors</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>    <span class="n">rois_on_feature_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rois_on_feature_maps</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>    <span class="c1"># Same thing with RPN probabilities, ie. shape (batch_size, nb_rois)</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>    <span class="n">rois_probas</span> <span class="o">=</span> <span class="n">rpn_predictions_cls</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>    <span class="c1"># Finally we select the final ROIs by deleting the invalid ones and by limiting the overlaps</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>    <span class="c1"># We cast the coordinateds to int in order to use them when cutting the ROIs</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>    <span class="c1"># TODO : Could we try to always get 300? --&gt; Shape consistente</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>    <span class="n">rois_on_feature_maps</span> <span class="o">=</span> <span class="n">select_final_rois</span><span class="p">(</span><span class="n">rois_on_feature_maps</span><span class="p">,</span> <span class="n">rois_probas</span><span class="p">,</span> <span class="n">roi_nms_overlap_threshold</span><span class="p">,</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>                                             <span class="n">nms_max_boxes</span><span class="p">,</span> <span class="n">feature_map_sizes</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>    <span class="k">return</span> <span class="n">rois_on_feature_maps</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_rois_bboxes_iou</span><span class="p">(</span><span class="n">rois</span><span class="p">,</span> <span class="n">img_data</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the ious between the ROIs (in rois) and the bboxes (in img_data).</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>rois</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>ROIs given by the RPN (ie. by the function get_roi_from_rpn_predictions())</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.get_rois_bboxes_iou--shape-n-4-n-corresponds-to-the-number-of-given-rois-in-general-max-300-cf-modelnms_max_boxes">Shape (N, 4), N corresponds to the number of given ROIs (in general max 300, cf. model.nms_max_boxes)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_data</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Metadata of the image after the preprocessing. In particular, the bboxes have been resized
and rotated if the image has been resized and rotated. We only use the 'bboxes' field</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subsampling_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Subsampling of the base model (shared layers) - to apply to bboxes (which are in image space)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: Dictionary containing all the IOUs betwee, ROIs and bboxes of the image
        Keys : (index_roi) -&gt; 'coordinates' -&gt; 'x1', 'y1', 'x2', 'y2', 'h', 'w'
                           -&gt; (index_bbox)  -&gt; 'coordinates': 'x1', 'y1', 'x2', 'y2'
                                            -&gt; 'iou'
                                            -&gt; 'class'</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1144" name="__codelineno-0-1144"></a><span class="k">def</span> <span class="nf">get_rois_bboxes_iou</span><span class="p">(</span><span class="n">rois</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the ious between the ROIs (in rois) and the bboxes (in img_data).</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a><span class="sd">        rois (np.ndarray): ROIs given by the RPN (ie. by the function get_roi_from_rpn_predictions())</span>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a><span class="sd">            # Shape (N, 4), N corresponds to the number of given ROIs (in general max 300, cf. model.nms_max_boxes)</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a><span class="sd">        img_data (dict): Metadata of the image after the preprocessing. In particular, the bboxes have been resized</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a><span class="sd">            and rotated if the image has been resized and rotated. We only use the &#39;bboxes&#39; field</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a><span class="sd">        subsampling_ratio (int): Subsampling of the base model (shared layers) - to apply to bboxes (which are in image space)</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a><span class="sd">        dict: Dictionary containing all the IOUs betwee, ROIs and bboxes of the image</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a><span class="sd">            Keys : (index_roi) -&gt; &#39;coordinates&#39; -&gt; &#39;x1&#39;, &#39;y1&#39;, &#39;x2&#39;, &#39;y2&#39;, &#39;h&#39;, &#39;w&#39;</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a><span class="sd">                               -&gt; (index_bbox)  -&gt; &#39;coordinates&#39;: &#39;x1&#39;, &#39;y1&#39;, &#39;x2&#39;, &#39;y2&#39;</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a><span class="sd">                                                -&gt; &#39;iou&#39;</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a><span class="sd">                                                -&gt; &#39;class&#39;</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>    <span class="c1"># Init. output dictionary</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>    <span class="n">dict_rois</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>    <span class="c1"># For each ROI, we get its coordinates, and the ious with each bbox of the image</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>    <span class="k">for</span> <span class="n">index_roi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rois</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>        <span class="c1"># Get the coordinates of each ROI</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>        <span class="n">x1_roi</span><span class="p">,</span> <span class="n">y1_roi</span><span class="p">,</span> <span class="n">x2_roi</span><span class="p">,</span> <span class="n">y2_roi</span> <span class="o">=</span> <span class="n">rois</span><span class="p">[</span><span class="n">index_roi</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h_roi</span><span class="p">,</span> <span class="n">w_roi</span> <span class="o">=</span> <span class="n">xyxy_to_xyhw</span><span class="p">(</span><span class="o">*</span><span class="n">rois</span><span class="p">[</span><span class="n">index_roi</span><span class="p">,</span> <span class="p">:])</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>        <span class="n">dict_roi</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>            <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="n">x1_roi</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">:</span> <span class="n">y1_roi</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2_roi</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2_roi</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h_roi</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">w_roi</span><span class="p">},</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>            <span class="s1">&#39;bboxes&#39;</span><span class="p">:</span> <span class="p">{}</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>        <span class="p">}</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>        <span class="c1"># Get the iou of each bbox</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>        <span class="k">for</span> <span class="n">index_bbox</span><span class="p">,</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]):</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>            <span class="c1"># bbox coordinates - input image format</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>            <span class="c1"># Bbox coordinates (input format, ie. image space)</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>            <span class="n">bbox_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">])</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>            <span class="c1"># Coordinates transformation to features map space</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>            <span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span> <span class="o">/</span> <span class="n">subsampling_ratio</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">bbox_coordinates</span><span class="p">)</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>            <span class="c1"># Calculus iou</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>            <span class="n">iou</span> <span class="o">=</span> <span class="n">get_iou</span><span class="p">((</span><span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span><span class="p">),</span> <span class="p">(</span><span class="n">x1_roi</span><span class="p">,</span> <span class="n">y1_roi</span><span class="p">,</span> <span class="n">x2_roi</span><span class="p">,</span> <span class="n">y2_roi</span><span class="p">))</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>            <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">index_bbox</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>                <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="n">x1_bbox</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">:</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2_bbox</span><span class="p">},</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>                <span class="s1">&#39;iou&#39;</span><span class="p">:</span> <span class="n">iou</span><span class="p">,</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>            <span class="p">}</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>        <span class="c1"># Append results</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>        <span class="n">dict_rois</span><span class="p">[</span><span class="n">index_roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_roi</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>    <span class="c1"># Returns</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>    <span class="k">return</span> <span class="n">dict_rois</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_rois_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_rois_targets</span><span class="p">(</span><span class="n">dict_rois</span><span class="p">,</span> <span class="n">classifier_min_overlap</span><span class="p">,</span> <span class="n">classifier_max_overlap</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Finds the bbox with the biggest iou with an ROI and associate them. Then associates the class
of this bbox to the ROI and, if the iou is sufficiently big, gives the associated regression.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dict_rois</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary containing all the ious between the ROIs and the bboxes of the image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classifier_min_overlap</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Minimal threshold to consider a ROI as a target of the classifier (which can still be 'bg')</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classifier_max_overlap</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Minimal threshold to consider a ROI as matching with a bbox (so with a class which is not 'bg')</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: Dictionary containing the 'viable' ROIs and their classification and regression targets</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1191" name="__codelineno-0-1191"></a><span class="k">def</span> <span class="nf">get_rois_targets</span><span class="p">(</span><span class="n">dict_rois</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">classifier_min_overlap</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">classifier_max_overlap</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Finds the bbox with the biggest iou with an ROI and associate them. Then associates the class</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a><span class="sd">    of this bbox to the ROI and, if the iou is sufficiently big, gives the associated regression.</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a><span class="sd">        dict_rois (dict): Dictionary containing all the ious between the ROIs and the bboxes of the image</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a><span class="sd">        classifier_min_overlap (float): Minimal threshold to consider a ROI as a target of the classifier (which can still be &#39;bg&#39;)</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a><span class="sd">        classifier_max_overlap (float): Minimal threshold to consider a ROI as matching with a bbox (so with a class which is not &#39;bg&#39;)</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a><span class="sd">        dict: Dictionary containing the &#39;viable&#39; ROIs and their classification and regression targets</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>    <span class="n">dict_rois_targets</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>    <span class="c1"># For each ROI ...</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>    <span class="k">for</span> <span class="n">roi_index</span><span class="p">,</span> <span class="n">dict_roi</span> <span class="ow">in</span> <span class="n">dict_rois</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>        <span class="c1"># ... get the coordinates ...</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>        <span class="n">coords_roi</span> <span class="o">=</span> <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>        <span class="n">x1_roi</span><span class="p">,</span> <span class="n">y1_roi</span><span class="p">,</span> <span class="n">x2_roi</span><span class="p">,</span> <span class="n">y2_roi</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords_roi</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">coords_roi</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">coords_roi</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">],</span> <span class="n">coords_roi</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">])</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>        <span class="c1"># ... get the best associated bbox (highest iou) ...</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a>        <span class="n">dict_iou</span> <span class="o">=</span> <span class="p">{</span><span class="n">bbox_index</span><span class="p">:</span> <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">bbox_index</span><span class="p">][</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">bbox_index</span> <span class="ow">in</span> <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]}</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>        <span class="n">best_bbox_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dict_iou</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dict_iou</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>        <span class="n">best_iou</span> <span class="o">=</span> <span class="n">dict_iou</span><span class="p">[</span><span class="n">best_bbox_index</span><span class="p">]</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a>        <span class="c1"># ... if best_iou lower than a threshold, we ignore this ROI ...</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a>        <span class="k">if</span> <span class="n">best_iou</span> <span class="o">&lt;</span> <span class="n">classifier_min_overlap</span><span class="p">:</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>            <span class="k">continue</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a>        <span class="c1"># ... otherwise, we define the best bbox and we complete the targets</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a>        <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_bbox_index</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>        <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;best_iou&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_iou</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a>        <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;classifier_regression_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a>        <span class="c1"># ... if best_iou is above a threshold, we consider a match on a class,</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a>        <span class="c1"># and get the regression target ...</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a>        <span class="k">if</span> <span class="n">best_iou</span> <span class="o">&gt;=</span> <span class="n">classifier_max_overlap</span><span class="p">:</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>            <span class="c1"># class</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a>            <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;classifier_class_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">best_bbox_index</span><span class="p">][</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a>            <span class="c1"># regression</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>            <span class="n">coords_bbox</span> <span class="o">=</span> <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">][</span><span class="n">best_bbox_index</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>            <span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span> <span class="o">=</span> <span class="n">coords_bbox</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="n">coords_bbox</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">],</span> <span class="n">coords_bbox</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">],</span> <span class="n">coords_bbox</span><span class="p">[</span><span class="s1">&#39;y2&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a>            <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;classifier_regression_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_regr</span><span class="p">((</span><span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span><span class="p">),</span> <span class="p">(</span><span class="n">x1_roi</span><span class="p">,</span> <span class="n">y1_roi</span><span class="p">,</span> <span class="n">x2_roi</span><span class="p">,</span> <span class="n">y2_roi</span><span class="p">))</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a>        <span class="c1"># ... otherwise, we consider the ROI to be background (ie. &#39;bg&#39;)</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>        <span class="c1"># Note : the regression target is not calculated if background</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>            <span class="n">dict_roi</span><span class="p">[</span><span class="s1">&#39;classifier_class_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bg&#39;</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>        <span class="c1"># Append results</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>        <span class="n">dict_rois_targets</span><span class="p">[</span><span class="n">roi_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_roi</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>    <span class="c1"># Returns</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>    <span class="k">return</span> <span class="n">dict_rois_targets</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_rpn_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_rpn_targets</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Gives the classification and regression targets for the RPN</p>

<details class="process-" open>
  <summary>We defined a set of possible anchor boxes (def. 9). For each point of the features map,</summary>
  <p>we look at the possible anchor boxes. We get back to the input image space and keep only
the anchor boxes which are totally included in the image. Then, for each anchor box, we check
if it matches with a bbox (via iou) and we define our target : match bbox vs match background
and gap between anchor box and bbox for the regression part (only if there is a match on a bbox).
We use this process for each image</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model</code></td>
          <td>
                <code>ModelKerasFasterRcnnObjectDetector</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Model used (contains all the necessary configs)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_data_batch</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The list of img_data (dict) for the batch.
Each entry is a dictionary with the content of an image (already preprocessed) and associated metadata:
        - 'img' -&gt; image in the numpy format (h, w, c), preprocessed and ready to be used by the model
        - 'bboxes' -&gt; (dict) associated bboxes (preprocessed image format)
             'x1', 'x2', 'y1', 'y2'
        - 'original_width' -&gt; Original width of the image
        - 'original_height' -&gt; Original height of the image
        - 'resized_width' -&gt; Resized width of the image (ie. smaller dim set to img_min_side_size px (def 300))
        - 'resized_height' -&gt; Resized height of the image (ie. smaller dim set to img_min_side_size px (def 300))
        - 'batch_width' -&gt; Width of the images in the batch (max width of the batch, we pad the smaller images with zeroes)
        - 'batch_height' -&gt; Height of the images in the batch (max height of the batch, we pad the smaller images with zeroes)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    np.ndarray: Classification targets : [y_is_box_valid] + [y_rpn_overlap] for each image with :
                - y_is_box_valid -&gt; if a box is valid (and thus, should enter in the classification loss)
                - y_rpn_overlap -&gt; target of the classification ('pos', 'neg' or 'neutral')
        # Shape (batch_size, feature_map_height, feature_map_width, nb_anchors * 2)
    np.ndarray: Regression targets : [y_rpn_overlap (repeated x 4)] + [y_rpn_regr] for each image with :
                - y_rpn_overlap -&gt; if a box is an object (and thus, should enter in the regression loss)
                    repeated to account for the 4 coordinates
                - y_rpn_regr -&gt; regression targets
        # Shape (batch_size, feature_map_height, feature_map_width, nb_anchors * 2 * 4)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="k">def</span> <span class="nf">get_rpn_targets</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">img_data_batch</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Gives the classification and regression targets for the RPN</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">    Process : We defined a set of possible anchor boxes (def. 9). For each point of the features map,</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">              we look at the possible anchor boxes. We get back to the input image space and keep only</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">              the anchor boxes which are totally included in the image. Then, for each anchor box, we check</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">              if it matches with a bbox (via iou) and we define our target : match bbox vs match background</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">              and gap between anchor box and bbox for the regression part (only if there is a match on a bbox).</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">              We use this process for each image</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">        model (ModelKerasFasterRcnnObjectDetector): Model used (contains all the necessary configs)</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">        img_data_batch (list): The list of img_data (dict) for the batch.</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">            Each entry is a dictionary with the content of an image (already preprocessed) and associated metadata:</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">                    - &#39;img&#39; -&gt; image in the numpy format (h, w, c), preprocessed and ready to be used by the model</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">                    - &#39;bboxes&#39; -&gt; (dict) associated bboxes (preprocessed image format)</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">                         &#39;x1&#39;, &#39;x2&#39;, &#39;y1&#39;, &#39;y2&#39;</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">                    - &#39;original_width&#39; -&gt; Original width of the image</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">                    - &#39;original_height&#39; -&gt; Original height of the image</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">                    - &#39;resized_width&#39; -&gt; Resized width of the image (ie. smaller dim set to img_min_side_size px (def 300))</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">                    - &#39;resized_height&#39; -&gt; Resized height of the image (ie. smaller dim set to img_min_side_size px (def 300))</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">                    - &#39;batch_width&#39; -&gt; Width of the images in the batch (max width of the batch, we pad the smaller images with zeroes)</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">                    - &#39;batch_height&#39; -&gt; Height of the images in the batch (max height of the batch, we pad the smaller images with zeroes)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">        np.ndarray: Classification targets : [y_is_box_valid] + [y_rpn_overlap] for each image with :</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">                    - y_is_box_valid -&gt; if a box is valid (and thus, should enter in the classification loss)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">                    - y_rpn_overlap -&gt; target of the classification (&#39;pos&#39;, &#39;neg&#39; or &#39;neutral&#39;)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">            # Shape (batch_size, feature_map_height, feature_map_width, nb_anchors * 2)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">        np.ndarray: Regression targets : [y_rpn_overlap (repeated x 4)] + [y_rpn_regr] for each image with :</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">                    - y_rpn_overlap -&gt; if a box is an object (and thus, should enter in the regression loss)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">                        repeated to account for the 4 coordinates</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">                    - y_rpn_regr -&gt; regression targets</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a><span class="sd">            # Shape (batch_size, feature_map_height, feature_map_width, nb_anchors * 2 * 4)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>    <span class="c1"># Extract params from model</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>    <span class="n">base_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">list_anchors</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>    <span class="n">nb_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nb_anchors</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="n">subsampling_ratio</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shared_model_subsampling</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>    <span class="n">rpn_min_overlap</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn_min_overlap</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="n">rpn_max_overlap</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn_max_overlap</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="n">rpn_regr_scaling</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn_regr_scaling</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">num_regions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rpn_restrict_num_regions</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>    <span class="c1"># Info batch size</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_data_batch</span><span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="c1"># Get size of the features map of the batch (for example by taking the first image)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span> <span class="o">=</span> <span class="n">get_feature_map_size</span><span class="p">(</span><span class="n">img_data_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_height&#39;</span><span class="p">],</span> <span class="n">img_data_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;batch_width&#39;</span><span class="p">],</span> <span class="n">subsampling_ratio</span><span class="p">)</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>    <span class="c1"># Setup target arrays</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>    <span class="n">Y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">nb_anchors</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>    <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">nb_anchors</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="c1"># We process each image</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">img_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_data_batch</span><span class="p">):</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>        <span class="c1"># Info image data</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>        <span class="n">im_resized_height</span><span class="p">,</span> <span class="n">im_resized_width</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_height&#39;</span><span class="p">],</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;resized_width&#39;</span><span class="p">]</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>        <span class="n">image_bboxes</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="c1"># Get the &quot;viable&quot; anchor boxes : one for each couple (point features map, base anchor) except if it does not fit</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>        <span class="c1"># in the image</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="n">anchor_boxes_dict</span> <span class="o">=</span> <span class="n">get_all_viable_anchors_boxes</span><span class="p">(</span><span class="n">base_anchors</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">feature_map_height</span><span class="p">,</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>                                                         <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">im_resized_height</span><span class="p">,</span> <span class="n">im_resized_width</span><span class="p">)</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>        <span class="c1"># Get iou for each couple (anchor box / bbox)</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="n">anchor_boxes_dict</span> <span class="o">=</span> <span class="n">get_iou_anchors_bboxes</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="c1"># Set anchor validity &amp; type for each anchor</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="c1"># - pos &amp; valid if match on a bbox (ie. an object)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="c1"># - neg &amp; valid if match on background</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>        <span class="c1"># - neutral &amp; invalid otherwise</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>        <span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">bboxes_index_with_no_positive</span> <span class="o">=</span> <span class="n">set_anchors_type_validity</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">,</span> <span class="n">rpn_min_overlap</span><span class="p">,</span> <span class="n">rpn_max_overlap</span><span class="p">)</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="c1"># We add at least one positive anchor box for each bbox which does not have one match</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="c1"># (in some cases, it is not possible, in that case : skip)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="n">anchor_boxes_dict</span> <span class="o">=</span> <span class="n">complete_at_least_one_anchor_per_bbox</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">bboxes_index_with_no_positive</span><span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="c1"># Invalidate some anchors in order not to have too many</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="n">anchor_boxes_dict</span> <span class="o">=</span> <span class="n">restrict_valid_to_n_regions</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>        <span class="c1"># Add the regression target for the positive and valid anchors</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="n">anchor_boxes_dict</span> <span class="o">=</span> <span class="n">add_regression_target_to_pos_valid</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="c1"># We have the anchors, their type and validity and the regression targets for the pos/valid anchors</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="c1"># We format the result. Here we initialize</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="n">y_rpn_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">nb_anchors</span><span class="p">))</span>  <span class="c1"># Target classifier</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="n">y_is_box_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">nb_anchors</span><span class="p">))</span>  <span class="c1"># couples (ix, anchor) which will enter the loss (ie. are not neutral)</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="n">y_rpn_regr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">feature_map_height</span><span class="p">,</span> <span class="n">feature_map_width</span><span class="p">,</span> <span class="n">nb_anchors</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>        <span class="c1"># For each anchor, we add data.</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>        <span class="c1"># The deleted anchors (because not &#39;viable&#39;) are not in anchor_boxes_dict, BUT all their characteristics should be zero</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>        <span class="c1"># which is the case thanks to the initialization</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>        <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>            <span class="n">y_rpn_overlap</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>            <span class="n">y_is_box_valid</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>            <span class="n">start_regr_index</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>            <span class="n">y_rpn_regr</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchor_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_regr_index</span><span class="p">:</span> <span class="n">start_regr_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;regression_target&#39;</span><span class="p">]</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>        <span class="c1"># We then concat all final arrays</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="c1"># For regression part, we add y_rpn_overlap (repeated) to y_rpn_regr in order to identify data that should be used by the regression loss</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>        <span class="n">y_rpn_cls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_is_box_valid</span><span class="p">,</span> <span class="n">y_rpn_overlap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">y_rpn_regr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">y_rpn_overlap</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">y_rpn_regr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="c1"># We scale the regression target</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>        <span class="n">y_rpn_regr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">y_rpn_regr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">rpn_regr_scaling</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>        <span class="c1"># We finally update the output arrays</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>        <span class="n">Y1</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">y_rpn_cls</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>        <span class="n">Y2</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">y_rpn_regr</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>    <span class="k">return</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_valid_boxes_from_coordinates" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_valid_boxes_from_coordinates</span><span class="p">(</span><span class="n">input_img</span><span class="p">,</span> <span class="n">input_rois</span><span class="p">,</span> <span class="n">fm_boxes_candidates</span><span class="p">,</span> <span class="n">regr_coordinates</span><span class="p">,</span> <span class="n">classifier_regr_scaling</span><span class="p">,</span> <span class="n">subsampling_ratio</span><span class="p">,</span> <span class="n">dict_classes</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Calculates the coordinates (in image space) after application of the regression of the boxes (in features map space) whose
probability is sufficiently high. Then restricts them to the image and keeps only the valid boxes</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>input_img</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Resized image (useful to get the dimensions)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>input_rois</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>ROIs given by the RPN</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fm_boxes_candidates</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The boxes (in features map space) valid with respect to their proba</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>regr_coordinates</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Regression prediction for the boxes</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>classifier_regr_scaling</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Scaling to remove from the regression results</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>subsampling_ratio</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Subsampling of the base model (shared layers) - to apply to bboxes (which are in image space)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dict_classes</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary of the classes of the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    A list of boxes valid from a probability AND coordinates xyxy points of view
        # Format [(cl, proba, coordinates), (...), ...)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1446" name="__codelineno-0-1446"></a><span class="k">def</span> <span class="nf">get_valid_boxes_from_coordinates</span><span class="p">(</span><span class="n">input_img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">input_rois</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fm_boxes_candidates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>                                     <span class="n">regr_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">classifier_regr_scaling</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">subsampling_ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>                                     <span class="n">dict_classes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Calculates the coordinates (in image space) after application of the regression of the boxes (in features map space) whose</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a><span class="sd">    probability is sufficiently high. Then restricts them to the image and keeps only the valid boxes</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a><span class="sd">        input_img (np.ndarray): Resized image (useful to get the dimensions)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a><span class="sd">        input_rois (np.ndarray): ROIs given by the RPN</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a><span class="sd">        fm_boxes_candidates (list): The boxes (in features map space) valid with respect to their proba</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a><span class="sd">        regr_coordinates (np.ndarray): Regression prediction for the boxes</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a><span class="sd">        classifier_regr_scaling (list): Scaling to remove from the regression results</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a><span class="sd">        subsampling_ratio (int): Subsampling of the base model (shared layers) - to apply to bboxes (which are in image space)</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a><span class="sd">        dict_classes (dict): Dictionary of the classes of the model</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a><span class="sd">        A list of boxes valid from a probability AND coordinates xyxy points of view</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a><span class="sd">            # Format [(cl, proba, coordinates), (...), ...)</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>    <span class="n">boxes_candidates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>    <span class="c1"># For each box (in features map space)...</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>    <span class="k">for</span> <span class="n">index_box</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">,</span> <span class="n">predicted_proba</span> <span class="ow">in</span> <span class="n">fm_boxes_candidates</span><span class="p">:</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>        <span class="n">roi_coordinates</span> <span class="o">=</span> <span class="n">input_rois</span><span class="p">[</span><span class="n">index_box</span><span class="p">]</span>  <span class="c1"># Get corresponding ROI</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>        <span class="n">regr_predicted</span> <span class="o">=</span> <span class="n">regr_coordinates</span><span class="p">[</span><span class="n">index_box</span><span class="p">][</span><span class="n">predicted_class</span> <span class="o">*</span> <span class="mi">4</span><span class="p">:</span> <span class="p">(</span><span class="n">predicted_class</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># Get the regression associated to this class</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>        <span class="n">regr_predicted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">regr_predicted</span><span class="p">,</span> <span class="n">classifier_regr_scaling</span><span class="p">)])</span>  <span class="c1"># Remove the scaling</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>        <span class="c1"># Apply predicted regression</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>        <span class="n">coordinates_after_regr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">apply_regression</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">roi_coordinates</span><span class="p">,</span> <span class="n">regr_predicted</span><span class="p">])))</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>        <span class="c1"># Make sure that the upper left point is in the features map</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>        <span class="n">coordinates_after_regr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">coordinates_after_regr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>        <span class="n">coordinates_after_regr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">coordinates_after_regr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>        <span class="n">bbox_fm_coords</span> <span class="o">=</span> <span class="n">xyhw_to_xyxy</span><span class="p">(</span><span class="o">*</span><span class="n">coordinates_after_regr</span><span class="p">)</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>        <span class="c1"># Get the coordinates in the input format (ie. in image space)</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>        <span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord</span> <span class="o">*</span> <span class="n">subsampling_ratio</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">bbox_fm_coords</span><span class="p">)</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>        <span class="c1"># Make sure that the point defining the box are in the image</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>        <span class="n">x1_bbox</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1_bbox</span><span class="p">)</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>        <span class="n">y1_bbox</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">)</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>        <span class="n">x2_bbox</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x2_bbox</span><span class="p">)</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>        <span class="n">y2_bbox</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">input_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y2_bbox</span><span class="p">)</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>        <span class="c1"># If the box is valid ...</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>        <span class="k">if</span> <span class="n">x1_bbox</span> <span class="o">&lt;</span> <span class="n">x2_bbox</span> <span class="ow">and</span> <span class="n">y1_bbox</span> <span class="o">&lt;</span> <span class="n">y2_bbox</span><span class="p">:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>            <span class="c1"># ... we add it to the list</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>            <span class="n">box_infos</span> <span class="o">=</span> <span class="p">(</span><span class="n">dict_classes</span><span class="p">[</span><span class="n">predicted_class</span><span class="p">],</span> <span class="n">predicted_proba</span><span class="p">,</span> <span class="p">(</span><span class="n">x1_bbox</span><span class="p">,</span> <span class="n">y1_bbox</span><span class="p">,</span> <span class="n">x2_bbox</span><span class="p">,</span> <span class="n">y2_bbox</span><span class="p">))</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>            <span class="n">boxes_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_infos</span><span class="p">)</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>    <span class="k">return</span> <span class="n">boxes_candidates</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.get_valid_fm_boxes_from_proba" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_valid_fm_boxes_from_proba</span><span class="p">(</span><span class="n">probas</span><span class="p">,</span> <span class="n">proba_threshold</span><span class="p">,</span> <span class="n">bg_index</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Keeps predicted (in features map space) boxes whose probability is above a threshold. Also deletes
all the boxes which matched on background</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>probas</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Probabilities of the boxes predicted by the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>proba_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Threshold below which, boxes are eliminated</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    A list of boxes (in features map space) valid from a probability point of view
        # Format [(index, index_cl, proba), (...), ...)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1421" name="__codelineno-0-1421"></a><span class="k">def</span> <span class="nf">get_valid_fm_boxes_from_proba</span><span class="p">(</span><span class="n">probas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">proba_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">bg_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Keeps predicted (in features map space) boxes whose probability is above a threshold. Also deletes</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a><span class="sd">    all the boxes which matched on background</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a><span class="sd">        probas (np.ndarray): Probabilities of the boxes predicted by the model</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a><span class="sd">        proba_threshold (float): Threshold below which, boxes are eliminated</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a><span class="sd">        A list of boxes (in features map space) valid from a probability point of view</span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a><span class="sd">            # Format [(index, index_cl, proba), (...), ...)</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a>    <span class="n">fm_boxes_candidates</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a>    <span class="c1"># For each box ...</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>    <span class="k">for</span> <span class="n">index_box</span><span class="p">,</span> <span class="n">box_probas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">probas</span><span class="p">):</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>        <span class="c1"># ... get the class ...</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>        <span class="n">predicted_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">box_probas</span><span class="p">)</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="c1"># ... get the corresponding probability ...</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>        <span class="n">predicted_proba</span> <span class="o">=</span> <span class="n">box_probas</span><span class="p">[</span><span class="n">predicted_class</span><span class="p">]</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>        <span class="c1"># ..., and, if we are above the threshold and the predicted class is not the background...</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>        <span class="k">if</span> <span class="n">predicted_proba</span> <span class="o">&gt;=</span> <span class="n">proba_threshold</span> <span class="ow">and</span> <span class="n">predicted_class</span> <span class="o">!=</span> <span class="n">bg_index</span><span class="p">:</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>            <span class="c1"># ... we add the box to the list</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>            <span class="n">fm_boxes_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index_box</span><span class="p">,</span> <span class="n">predicted_class</span><span class="p">,</span> <span class="n">predicted_proba</span><span class="p">))</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>    <span class="k">return</span> <span class="n">fm_boxes_candidates</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.limit_rois_targets" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">limit_rois_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Limits the number of input / output for each image in order not to have OOM</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>dict_rois</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dictionary containing the possible inputs / targets of the classifier</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nb_rois_per_img</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximal number of ROIs to return for each image
In the rare case where there are not enough ROIs, we clone the ROIs in order to have enough
If no ROI, we return None. This case is then handled by the function create_fake_dict_rois_targets</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: The dictionary containing the "selected" dictionary</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1238" name="__codelineno-0-1238"></a><span class="k">def</span> <span class="nf">limit_rois_targets</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Limits the number of input / output for each image in order not to have OOM</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a><span class="sd">        dict_rois (dict): Dictionary containing the possible inputs / targets of the classifier</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a><span class="sd">        nb_rois_per_img (int): Maximal number of ROIs to return for each image</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a><span class="sd">            In the rare case where there are not enough ROIs, we clone the ROIs in order to have enough</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a><span class="sd">            If no ROI, we return None. This case is then handled by the function create_fake_dict_rois_targets</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a><span class="sd">        dict: The dictionary containing the &quot;selected&quot; dictionary</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>    <span class="c1"># Get the positive and negative ROIs</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>    <span class="n">pos_rois_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi_index</span> <span class="k">for</span> <span class="n">roi_index</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">dict_rois_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;classifier_class_target&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;bg&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>    <span class="n">neg_rois_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">roi_index</span> <span class="k">for</span> <span class="n">roi_index</span><span class="p">,</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">dict_rois_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="s1">&#39;classifier_class_target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bg&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>    <span class="c1"># Case 1 : no ROI (very rare ?!), return None</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning, there is an image for which we do not have a target ROI for the classifier.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>    <span class="c1"># Case 2 : not enough ROIs</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nb_rois_per_img</span><span class="p">:</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning, there is an image for which we have less than </span><span class="si">{</span><span class="n">nb_rois_per_img</span><span class="si">}</span><span class="s2"> target ROIs. We randomly clone some ROIs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>        <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">pos_rois_indexes</span> <span class="o">+</span> <span class="n">neg_rois_indexes</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>        <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">))</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>        <span class="n">selected_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">,</span> <span class="n">nb_rois_per_img</span><span class="p">))</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>    <span class="c1"># Case 3 : enough ROIs</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>        <span class="c1"># Case 3.1 : not enough positive ROIs</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nb_rois_per_img</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>            <span class="n">selected_neg_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="p">(</span><span class="n">nb_rois_per_img</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">)))</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">pos_rois_indexes</span> <span class="o">+</span> <span class="n">selected_neg_indexes</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">))</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>        <span class="c1"># Cas 3.2 : not enough negative ROIs</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nb_rois_per_img</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>            <span class="n">selected_pos_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="p">(</span><span class="n">nb_rois_per_img</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">)))</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">selected_pos_indexes</span> <span class="o">+</span> <span class="n">neg_rois_indexes</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">))</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>        <span class="c1"># Cas 3.3 : nominal case, we have everything we need</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>            <span class="n">selected_pos_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pos_rois_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">nb_rois_per_img</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>            <span class="n">selected_neg_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">neg_rois_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="p">(</span><span class="n">nb_rois_per_img</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_pos_indexes</span><span class="p">)))</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">selected_pos_indexes</span> <span class="o">+</span> <span class="n">selected_neg_indexes</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>            <span class="n">selected_indexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">))</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>    <span class="c1"># We return the ROIs whose index are in selected_indexes</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>    <span class="c1"># We are careful to manage &quot;duplicates&quot; in the list of selected indices</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>    <span class="k">return</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dict_rois_targets</span><span class="p">[</span><span class="n">roi_index</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">roi_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_indexes</span><span class="p">)}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">non_max_suppression_fast</span><span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">,</span> <span class="n">nms_overlap_threshold</span><span class="p">,</span> <span class="n">nms_max_boxes</span><span class="p">,</span> <span class="n">img_boxes_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Filters boxes in order to limit overlaps on the same object using a list of boxes (ROIs or final predictions)
and the probabilities of matching with an object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>img_boxes_coordinates</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The coordinates of the boxes (in opposite points format)</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes-4">shape: (nb_boxes, 4)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>img_boxes_probas</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The probabilities associated to the boxes</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast--shape-nb_boxes">shape: (nb_boxes)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nms_overlap_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The iou value above which we assume that two boxes overlap</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nms_max_boxes</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The maximal number of boxes that this function can return</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Kwargs:
    img_boxes_classes (np.ndarray): The classes associated with the boxes (optional)
        # shape: (nb_boxes)
Raises:
    ValueError: If img_boxes_probas is not the same length as img_boxes_coordinates
    ValueError: If nms_overlap_threshold &lt;= 0 or &gt; 1
    ValueError: If nms_max_boxes &lt; 1
    ValueError: If img_boxes_classes is not the same length as img_boxes_coordinates (if != None)
Returns:
    np.ndarray: List of kept boxes
        # shape: (nb_boxes_kept, 4)
    np.ndarray: Associated probabilities
    np.ndarray: Associated classes (if prediction)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="k">def</span> <span class="nf">non_max_suppression_fast</span><span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nms_overlap_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                             <span class="n">nms_max_boxes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">img_boxes_classes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Filters boxes in order to limit overlaps on the same object using a list of boxes (ROIs or final predictions)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="sd">    and the probabilities of matching with an object.</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        img_boxes_coordinates (np.ndarray): The coordinates of the boxes (in opposite points format)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">            # shape: (nb_boxes, 4)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        img_boxes_probas (np.ndarray): The probabilities associated to the boxes</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">            # shape: (nb_boxes)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">        nms_overlap_threshold (float): The iou value above which we assume that two boxes overlap</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        nms_max_boxes (int): The maximal number of boxes that this function can return</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">    Kwargs:</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        img_boxes_classes (np.ndarray): The classes associated with the boxes (optional)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">            # shape: (nb_boxes)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">        ValueError: If img_boxes_probas is not the same length as img_boxes_coordinates</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">        ValueError: If nms_overlap_threshold &lt;= 0 or &gt; 1</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">        ValueError: If nms_max_boxes &lt; 1</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">        ValueError: If img_boxes_classes is not the same length as img_boxes_coordinates (if != None)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">        np.ndarray: List of kept boxes</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">            # shape: (nb_boxes_kept, 4)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">        np.ndarray: Associated probabilities</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        np.ndarray: Associated classes (if prediction)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="c1"># code taken from here: http://www.pyimagesearch.com/2015/02/16/faster-non-maximum-suppression-python/</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="c1"># if there are no boxes, returns an empty list</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="c1"># Manage errors</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="k">if</span> <span class="n">img_boxes_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img_boxes_probas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The arrays img_boxes_coordinates and img_boxes_probas must have the same length.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">nms_overlap_threshold</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The value of nms_overlap_threshold must be between 0 and 1 (0 excluded, 1 included)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>    <span class="k">if</span> <span class="n">nms_max_boxes</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The argument nms_max_boxes must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="k">if</span> <span class="n">img_boxes_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img_boxes_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">img_boxes_classes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The arrays img_boxes_coordinates and img_boxes_classes must have the same length.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="c1"># Process explanation:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="c1">#   Step 1: Sort the probs list</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="c1">#   Step 2: Find the larget prob &#39;Last&#39; in the list and save it to the pick list</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="c1">#   Step 3: Calculate the IoU with &#39;Last&#39; box and other boxes in the list. If the IoU is larger than overlap_threshold, delete the box from list</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="c1">#   Step 4: Repeat step 2 and step 3 until there is no item in the probs list</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="c1"># If empty, return an empty array</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="c1"># Grab the coordinates of the boxes &amp; calculate the areas</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">x1_box</span><span class="p">,</span> <span class="n">y1_box</span><span class="p">,</span> <span class="n">x2_box</span><span class="p">,</span> <span class="n">y2_box</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="n">boxes_areas</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2_box</span> <span class="o">-</span> <span class="n">x1_box</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2_box</span> <span class="o">-</span> <span class="n">y1_box</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="c1"># We now loop over each boxes, sorted by max probas</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="n">picked_index</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">img_boxes_probas</span><span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="c1"># Keep looping while some indexes still remain in the list</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="c1"># If we have enough boxes, break</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">picked_index</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nms_max_boxes</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">break</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="c1"># Add highest proba remaining to picked indexes</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>        <span class="n">picked_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="c1"># Find intersection area between picked box &amp; remaining candidates</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">xx1_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x1_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">x1_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">yy1_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y1_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">y1_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="n">xx2_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">x2_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">x2_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">yy2_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y2_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">y2_box</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">ww_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xx2_int</span> <span class="o">-</span> <span class="n">xx1_int</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">hh_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">yy2_int</span> <span class="o">-</span> <span class="n">yy1_int</span><span class="p">)</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="n">area_int</span> <span class="o">=</span> <span class="n">ww_int</span> <span class="o">*</span> <span class="n">hh_int</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="c1"># Get the union</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="n">area_union</span> <span class="o">=</span> <span class="n">boxes_areas</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">boxes_areas</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">area_int</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="c1"># Compute the overlap (i.e. iou)</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="n">overlap</span> <span class="o">=</span> <span class="n">area_int</span> <span class="o">/</span> <span class="p">(</span><span class="n">area_union</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="c1"># Delete last index (selected) &amp; all indexes from the index list that have an IOU higher than a given threhsold</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">overlap</span> <span class="o">&gt;</span> <span class="n">nms_overlap_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>    <span class="c1"># Return only the boxes that were picked</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>    <span class="n">img_boxes_coordinates</span> <span class="o">=</span> <span class="n">img_boxes_coordinates</span><span class="p">[</span><span class="n">picked_index</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>    <span class="k">if</span> <span class="n">img_boxes_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="k">return</span> <span class="n">img_boxes_coordinates</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">[</span><span class="n">picked_index</span><span class="p">],</span> <span class="n">img_boxes_classes</span><span class="p">[</span><span class="n">picked_index</span><span class="p">]</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="k">return</span> <span class="n">img_boxes_coordinates</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">[</span><span class="n">picked_index</span><span class="p">],</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">non_max_suppression_fast_on_preds</span><span class="p">(</span><span class="n">boxes_candidates</span><span class="p">,</span> <span class="n">nms_overlap_threshold</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Applies the NMS algorithm on the valid predicted boxes to avoid overlaps.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>boxes_candidates</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Valid predicted boxes</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.non_max_suppression_fast_on_preds--format-cl-proba-coordinates">Format [(cl, proba, coordinates), (...), ...)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nms_overlap_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Above this threshold for the iou, two boxes are said to be overlapping</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    A list of boxes valid from a probability AND coordinates xyxy points of view and with "no" overlap
        # Format [(cl, proba, coordinates), (...), ...)</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1491" name="__codelineno-0-1491"></a><span class="k">def</span> <span class="nf">non_max_suppression_fast_on_preds</span><span class="p">(</span><span class="n">boxes_candidates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="n">nms_overlap_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Applies the NMS algorithm on the valid predicted boxes to avoid overlaps.</span>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a><span class="sd">        boxes_candidates (list): Valid predicted boxes</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a><span class="sd">            # Format [(cl, proba, coordinates), (...), ...)</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a><span class="sd">        nms_overlap_threshold (float): Above this threshold for the iou, two boxes are said to be overlapping</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a><span class="sd">        A list of boxes valid from a probability AND coordinates xyxy points of view and with &quot;no&quot; overlap</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a><span class="sd">            # Format [(cl, proba, coordinates), (...), ...)</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>    <span class="c1"># If there are no valid boxes</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes_candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>    <span class="c1"># First we format the inputs to the format for the NMS</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>    <span class="n">img_boxes_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cl</span> <span class="k">for</span> <span class="n">cl</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">boxes_candidates</span><span class="p">])</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>    <span class="n">img_boxes_probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">proba</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">proba</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">boxes_candidates</span><span class="p">])</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>    <span class="n">img_boxes_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">coordinates</span> <span class="ow">in</span> <span class="n">boxes_candidates</span><span class="p">])</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>    <span class="c1"># Apply NMS</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>    <span class="n">nms_result</span> <span class="o">=</span> <span class="n">non_max_suppression_fast</span><span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">,</span> <span class="n">nms_overlap_threshold</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">img_boxes_classes</span><span class="o">=</span><span class="n">img_boxes_classes</span><span class="p">)</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>    <span class="n">img_boxes_coordinates</span><span class="p">,</span> <span class="n">img_boxes_probas</span><span class="p">,</span> <span class="n">img_boxes_classes</span> <span class="o">=</span> <span class="n">nms_result</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>    <span class="c1"># Format final result</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>    <span class="n">final_boxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img_boxes_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>        <span class="n">final_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_boxes_classes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img_boxes_probas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">img_boxes_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>    <span class="c1"># Return</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>    <span class="k">return</span> <span class="n">final_boxes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.restrict_and_convert_roi_boxes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">restrict_and_convert_roi_boxes</span><span class="p">(</span><span class="n">bbox_coordinates</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Resizes the box to have the minimal size and crops it to stay in the features map. Finally,
converts it in xyxy coordinates.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>bbox_coordinates</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An array composed of 6 objects : x_roi, y_roi, h_roi, w_roi, height_img_in_feature_map, width_img_in_feature_map.
(x_roi, y_roi, h_roi, w_roi) are the coordinates of a ROI
(height_img_in_feature_map, width_img_in_feature_map) sont les tailles avant padding de l'image correspondantes, puis downsampled au format feature map</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    float: Coordinates of the ROI after correction - x coordinate of the upper left point
    float: Coordinates of the ROI after correction - y coordinate of the upper left point
    float: Coordinates of the ROI after correction - x coordinate of the bottom right point
    float: Coordinates of the ROI after correction - y coordinate of the bottom right point</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-989" name="__codelineno-0-989"></a><span class="k">def</span> <span class="nf">restrict_and_convert_roi_boxes</span><span class="p">(</span><span class="n">bbox_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Resizes the box to have the minimal size and crops it to stay in the features map. Finally,</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a><span class="sd">    converts it in xyxy coordinates.</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a><span class="sd">        bbox_coordinates (np.ndarray): An array composed of 6 objects : x_roi, y_roi, h_roi, w_roi, height_img_in_feature_map, width_img_in_feature_map.</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a><span class="sd">            (x_roi, y_roi, h_roi, w_roi) are the coordinates of a ROI</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a><span class="sd">            (height_img_in_feature_map, width_img_in_feature_map) sont les tailles avant padding de l&#39;image correspondantes, puis downsampled au format feature map</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a><span class="sd">        float: Coordinates of the ROI after correction - x coordinate of the upper left point</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a><span class="sd">        float: Coordinates of the ROI after correction - y coordinate of the upper left point</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a><span class="sd">        float: Coordinates of the ROI after correction - x coordinate of the bottom right point</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a><span class="sd">        float: Coordinates of the ROI after correction - y coordinate of the bottom right point</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">height_img_in_feature_map</span><span class="p">,</span> <span class="n">width_img_in_feature_map</span> <span class="o">=</span> <span class="n">bbox_coordinates</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>    <span class="c1"># We want the box to have a size of at least 1</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>    <span class="c1"># We want the upper left point to be in the image (projected on the features map)</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>    <span class="c1"># Convert in xyxy (opposite points format)</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">xyhw_to_xyxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>    <span class="c1"># We want the bottom right point to be in the image (projected on the features map)</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">width_img_in_feature_map</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">height_img_in_feature_map</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>    <span class="c1"># Return new coordinates</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.restrict_valid_to_n_regions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">restrict_valid_to_n_regions</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Restricts the number of valid anchor boxes.
If there are more positive anchor boxes than hald of num_regions :
    - we invalidate positive anchors until there are less than num_regions / 2
    - Then, we invalidate positive anchors until the number of valid anchors is equal to num_regions</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>anchor_boxes_dict</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Anchor boxes dictionary
- 'anchor_img_coordinates': Coordinates of the anchor box (input format ie. image space)
- 'bboxes': bboxes with their coordinates xyxy (in image space) and iou
- 'anchor_type': anchor type (pos, neg or neutral)
- 'anchor_validity': anchor validity
- 'best_bbox_index': bbox associated to this anchor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>num_regions</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of valid anchors we want to consider</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    dict: Updated anchor boxes dictionary</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-814" name="__codelineno-0-814"></a><span class="k">def</span> <span class="nf">restrict_valid_to_n_regions</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Restricts the number of valid anchor boxes.</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a><span class="sd">    If there are more positive anchor boxes than hald of num_regions :</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a><span class="sd">        - we invalidate positive anchors until there are less than num_regions / 2</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a><span class="sd">        - Then, we invalidate positive anchors until the number of valid anchors is equal to num_regions</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a><span class="sd">        anchor_boxes_dict (dict): Anchor boxes dictionary</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a><span class="sd">            - &#39;anchor_img_coordinates&#39;: Coordinates of the anchor box (input format ie. image space)</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a><span class="sd">            - &#39;bboxes&#39;: bboxes with their coordinates xyxy (in image space) and iou</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a><span class="sd">            - &#39;anchor_type&#39;: anchor type (pos, neg or neutral)</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a><span class="sd">            - &#39;anchor_validity&#39;: anchor validity</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a><span class="sd">            - &#39;best_bbox_index&#39;: bbox associated to this anchor</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a><span class="sd">        num_regions (int): The number of valid anchors we want to consider</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a><span class="sd">        dict: Updated anchor boxes dictionary</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>    <span class="c1"># We look at both positive and negative anchor boxes</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>    <span class="c1"># No need to test for validity at this point, positive and negative anchor boxes are necessarily valid</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>    <span class="n">positive_anchor_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">anchor_idx</span> <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pos&#39;</span><span class="p">]</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>    <span class="n">negative_anchor_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">anchor_idx</span> <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;neg&#39;</span><span class="p">]</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>    <span class="c1"># First we invalidate the surplus of positive anchors if needed ...</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>    <span class="n">nb_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_indexes</span><span class="p">)</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>    <span class="n">nb_pos_to_invalidate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nb_pos</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_regions</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>    <span class="k">if</span> <span class="n">nb_pos_to_invalidate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>        <span class="c1"># Random select</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>        <span class="n">anchors_indexes_to_unvalid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">positive_anchor_indexes</span><span class="p">,</span> <span class="n">nb_pos_to_invalidate</span><span class="p">)</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>        <span class="k">for</span> <span class="n">anchor_idx</span> <span class="ow">in</span> <span class="n">anchors_indexes_to_unvalid</span><span class="p">:</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>            <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">][</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>        <span class="n">nb_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_regions</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>    <span class="c1"># ... Then we invalidate negative regions until we have num_regions valid anchor boxes</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>    <span class="n">nb_neg_to_invalidate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_anchor_indexes</span><span class="p">)</span> <span class="o">+</span> <span class="n">nb_pos</span> <span class="o">-</span> <span class="n">num_regions</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>    <span class="k">if</span> <span class="n">nb_neg_to_invalidate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>        <span class="c1"># Random select</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>        <span class="n">anchors_indexes_to_unvalid</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">negative_anchor_indexes</span><span class="p">,</span> <span class="n">nb_neg_to_invalidate</span><span class="p">)</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>        <span class="k">for</span> <span class="n">anchor_idx</span> <span class="ow">in</span> <span class="n">anchors_indexes_to_unvalid</span><span class="p">:</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>            <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">][</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a>    <span class="c1"># Return updated dict</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a>    <span class="k">return</span> <span class="n">anchor_boxes_dict</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">select_final_rois</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">,</span> <span class="n">rois_probas</span><span class="p">,</span> <span class="n">roi_nms_overlap_threshold</span><span class="p">,</span> <span class="n">nms_max_boxes</span><span class="p">,</span> <span class="n">feature_map_sizes</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Deletes the invalid ROIs and selects some of them to limit the overlaps</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>rois_coordinates</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of all selected ROIs for all the images of the batch</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois-4">shape: (batch_size, nb_rois, 4)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rois_probas</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The probabilities associated to each selected ROIsfor all the images</p>
<h3 id="template_vision.models_training.object_detectors.utils_object_detectors.select_final_rois--shape-batch_size-nb_rois">shape: (batch_size, nb_rois)</h3>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>roi_nms_overlap_threshold</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Above this threshold for the iou, we assume that two ROIs overlap</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>nms_max_boxes</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Maximal number of ROIs that this function can return for each image</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>feature_map_sizes</code></td>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Theoretical heights and widths of the features maps - useful if we have no valid ROI anymore.
Allows to manage the fact that, in a batch, we padded the images so that they all have the same size
    # shape: (batch_size, 2)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Returns:
    list<np.ndarray>: Final list of the ROIs selected for the classifier part</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="k">def</span> <span class="nf">select_final_rois</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">rois_probas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">roi_nms_overlap_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>                      <span class="n">nms_max_boxes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">feature_map_sizes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Deletes the invalid ROIs and selects some of them to limit the overlaps</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a><span class="sd">        rois_coordinates (np.ndarray): The set of all selected ROIs for all the images of the batch</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a><span class="sd">            # shape: (batch_size, nb_rois, 4)</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a><span class="sd">        rois_probas (np.ndarray): The probabilities associated to each selected ROIsfor all the images</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a><span class="sd">            # shape: (batch_size, nb_rois)</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a><span class="sd">        roi_nms_overlap_threshold (float): Above this threshold for the iou, we assume that two ROIs overlap</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a><span class="sd">        nms_max_boxes (int): Maximal number of ROIs that this function can return for each image</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a><span class="sd">        feature_map_sizes (np.ndarray): Theoretical heights and widths of the features maps - useful if we have no valid ROI anymore.</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a><span class="sd">            Allows to manage the fact that, in a batch, we padded the images so that they all have the same size</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a><span class="sd">                # shape: (batch_size, 2)</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a><span class="sd">        list&lt;np.ndarray&gt;: Final list of the ROIs selected for the classifier part</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>    <span class="c1"># We process each image of the batch separately and stocks the results in list_rois</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>    <span class="c1"># We can&#39;t return a numpy array because the number of ROIs for each image is not the same -&gt; we return a list</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>    <span class="n">list_rois</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>    <span class="k">for</span> <span class="n">img_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rois_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>        <span class="c1"># Get infos</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>        <span class="n">img_rois_coordinates</span> <span class="o">=</span> <span class="n">rois_coordinates</span><span class="p">[</span><span class="n">img_index</span><span class="p">]</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a>        <span class="n">img_rois_probas</span> <span class="o">=</span> <span class="n">rois_probas</span><span class="p">[</span><span class="n">img_index</span><span class="p">]</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a>        <span class="c1"># Eliminate invalid anchors</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a>        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>        <span class="n">img_rois_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>        <span class="n">img_rois_probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">img_rois_probas</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a>        <span class="c1"># In the rare cases where there are no more ROIs, we create one artificially (the whole image)</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a>        <span class="k">if</span> <span class="n">img_rois_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Warning, there is an image for which we can&#39;t find a valid ROI.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;By default, we create an artificial ROI which cover the whole image.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>            <span class="n">height_img_in_feature_map</span><span class="p">,</span> <span class="n">width_img_in_feature_map</span> <span class="o">=</span> <span class="n">feature_map_sizes</span><span class="p">[</span><span class="n">img_index</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a>            <span class="n">img_rois_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width_img_in_feature_map</span><span class="p">,</span> <span class="n">height_img_in_feature_map</span><span class="p">]])</span>  <span class="c1"># x1, y1, x2, y2</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>        <span class="c1"># Otherwise, we continue the process</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>            <span class="c1"># We keep the ROIs which do not overlap</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>            <span class="n">img_rois_coordinates</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">non_max_suppression_fast</span><span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">,</span> <span class="n">img_rois_probas</span><span class="p">,</span> <span class="n">roi_nms_overlap_threshold</span><span class="p">,</span> <span class="n">nms_max_boxes</span><span class="p">)</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>            <span class="c1"># Finally, we cast to int (because we will cut the features map per index)</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>            <span class="c1"># Round</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>            <span class="n">img_rois_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>            <span class="c1"># Delete invalid ROIs again (after rounding)</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>            <span class="n">img_rois_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>        <span class="c1"># Append result</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>        <span class="n">list_rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_rois_coordinates</span><span class="p">)</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>    <span class="c1"># Return ROIs</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>    <span class="k">return</span> <span class="n">list_rois</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.set_anchors_type_validity" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">set_anchors_type_validity</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">,</span> <span class="n">rpn_min_overlap</span><span class="p">,</span> <span class="n">rpn_max_overlap</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Defines the type and the validity of each anchor
    Type:
        - pos -&gt; Match between the anchor and a bbox
        - neg -&gt; Match between the anchor and the background
        - neutral -&gt; In between the two, won't be used by the model
    Validity:
        - 1 -&gt; If pos or neg
        - 0 -&gt; If neutral
Args:
    anchor_boxes_dict (dict): Anchor boxes dictionary
        - 'anchor_img_coordinates': Coordinates of the anchor box (input format ie. image space)
        - 'bboxes': bboxes with their coordinates xyxy (in image space) and iou
    image_bboxes (list<dict>): List of bboxes of the image
    rpn_min_overlap (float): Threshold below which a bbox is marked as negative
    rpn_max_overlap (float): Threshold aboce which a bbox is marked as positive
Returns:
    dict: Dictionary of the anchors boxes (input dictionary) with type and validity added ('anchor_type', 'anchor_validity')
    list: Liste of the bboxes with no positive anchor associated</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-725" name="__codelineno-0-725"></a><span class="k">def</span> <span class="nf">set_anchors_type_validity</span><span class="p">(</span><span class="n">anchor_boxes_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">image_bboxes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">rpn_min_overlap</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>                              <span class="n">rpn_max_overlap</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Defines the type and the validity of each anchor</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a><span class="sd">        Type:</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a><span class="sd">            - pos -&gt; Match between the anchor and a bbox</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="sd">            - neg -&gt; Match between the anchor and the background</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a><span class="sd">            - neutral -&gt; In between the two, won&#39;t be used by the model</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="sd">        Validity:</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">            - 1 -&gt; If pos or neg</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">            - 0 -&gt; If neutral</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">        anchor_boxes_dict (dict): Anchor boxes dictionary</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="sd">            - &#39;anchor_img_coordinates&#39;: Coordinates of the anchor box (input format ie. image space)</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">            - &#39;bboxes&#39;: bboxes with their coordinates xyxy (in image space) and iou</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="sd">        image_bboxes (list&lt;dict&gt;): List of bboxes of the image</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><span class="sd">        rpn_min_overlap (float): Threshold below which a bbox is marked as negative</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a><span class="sd">        rpn_max_overlap (float): Threshold aboce which a bbox is marked as positive</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">        dict: Dictionary of the anchors boxes (input dictionary) with type and validity added (&#39;anchor_type&#39;, &#39;anchor_validity&#39;)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">        list: Liste of the bboxes with no positive anchor associated</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="n">bboxes_index_with_positive</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>    <span class="c1"># For each anchor ...</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>    <span class="k">for</span> <span class="n">anchor_idx</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchor_boxes_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="c1"># Get the dictionary where the keys are the bboxes and the values, the iou</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">dict_iou</span> <span class="o">=</span> <span class="p">{</span><span class="n">index_bbox</span><span class="p">:</span> <span class="n">dict_bbox</span><span class="p">[</span><span class="s1">&#39;iou&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">index_bbox</span><span class="p">,</span> <span class="n">dict_bbox</span> <span class="ow">in</span> <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>        <span class="c1"># Get max iou (if for some reason no bbox, set it to 0 (i.e &#39;neg&#39;))</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>        <span class="n">max_iou</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dict_iou</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_iou</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>        <span class="c1"># If we are above threshold max, the anchor is positive and valid</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>        <span class="k">if</span> <span class="n">max_iou</span> <span class="o">&gt;</span> <span class="n">rpn_max_overlap</span><span class="p">:</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>            <span class="n">best_bbox_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dict_iou</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">dict_iou</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_bbox_index</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>            <span class="n">bboxes_index_with_positive</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">best_bbox_index</span><span class="p">)</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>        <span class="c1"># If we are below threshold min, the anchor is negative and valid</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">max_iou</span> <span class="o">&lt;</span> <span class="n">rpn_min_overlap</span><span class="p">:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neg&#39;</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="c1"># Otherwise, it is invalid (and we set it to neutral)</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;anchor_validity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>            <span class="n">anchor</span><span class="p">[</span><span class="s1">&#39;best_bbox_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>        <span class="n">anchor_boxes_dict</span><span class="p">[</span><span class="n">anchor_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">anchor</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="c1"># Get list of bboxes index without positive anchor</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="n">bboxes_index_with_no_positive</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_bbox</span> <span class="k">for</span> <span class="n">index_bbox</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_bboxes</span><span class="p">))</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>                                     <span class="k">if</span> <span class="n">index_bbox</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bboxes_index_with_positive</span><span class="p">]</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>    <span class="k">return</span> <span class="n">anchor_boxes_dict</span><span class="p">,</span> <span class="n">bboxes_index_with_no_positive</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.xyhw_to_xyxy" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">xyhw_to_xyxy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Changes a rectangle in the format xyhw (x, y, h, w) to
the format xyxy (x1, y1, x2, y2)</p>

<details class="args-" open>
  <summary>Args</summary>
  <p>x (float): x coordinate of the upper left point
y (float): y coordinate of the upper left point
h (float): height of the rectangle
w (float): width of the rectangle</p>
</details>      <p>Returns:
    float: x coordinate of the upper left point
    float: y coordinate of the upper left point
    float: x coordinate of the bottom right point
    float: y coordinate of the bottom right point</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="nd">@check_coordinates_validity</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="k">def</span> <span class="nf">xyhw_to_xyxy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Changes a rectangle in the format xyhw (x, y, h, w) to</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">    the format xyxy (x1, y1, x2, y2)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">    Args :</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">        x (float): x coordinate of the upper left point</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">        y (float): y coordinate of the upper left point</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">        h (float): height of the rectangle</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">        w (float): width of the rectangle</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        float: x coordinate of the upper left point</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        float: y coordinate of the upper left point</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        float: x coordinate of the bottom right point</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        float: y coordinate of the bottom right point</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_cxcyhw" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">xyxy_to_cxcyhw</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Changes a rectangle in the format xyxy (x1, y1, x2, y2) to
the format cxcyhw (cx, cy, h, w)</p>

<details class="args-" open>
  <summary>Args</summary>
  <p>x1 (float): x coordinate of the upper left point
y1 (float): y coordinate of the upper left point
x2 (float): x coordinate of the bottom right point
y2 (float): y coordinate of the bottom right point</p>
</details>      <p>Returns:
    float: x coordinate of the center of the rectangle
    float: y coordinate of the center of the rectangle
    float: height of the rectangle
    float: width of the rectangle</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="nd">@check_coordinates_validity</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="k">def</span> <span class="nf">xyxy_to_cxcyhw</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Changes a rectangle in the format xyxy (x1, y1, x2, y2) to</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    the format cxcyhw (cx, cy, h, w)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    Args :</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        x1 (float): x coordinate of the upper left point</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        y1 (float): y coordinate of the upper left point</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">        x2 (float): x coordinate of the bottom right point</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        y2 (float): y coordinate of the bottom right point</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        float: x coordinate of the center of the rectangle</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        float: y coordinate of the center of the rectangle</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        float: height of the rectangle</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        float: width of the rectangle</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="n">width</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="n">height</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="k">return</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="template_vision.models_training.object_detectors.utils_object_detectors.xyxy_to_xyhw" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">xyxy_to_xyhw</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Changes a rectangle in the format xyxy (x1, y1, x2, y2) to
the format xyhw (x, y, h, w)</p>

<details class="args-" open>
  <summary>Args</summary>
  <p>x1 (float): x coordinate of the upper left point
y1 (float): y coordinate of the upper left point
x2 (float): x coordinate of the bottom right point
y2 (float): y coordinate of the bottom right point</p>
</details>      <p>Returns:
    float: x coordinate of the upper left point
    float: y coordinate of the upper left point
    float: height of the rectangle
    float: width of the rectangle</p>

          <details class="quote">
            <summary>Source code in <code>template_vision/models_training/object_detectors/utils_object_detectors.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="nd">@check_coordinates_validity</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="k">def</span> <span class="nf">xyxy_to_xyhw</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;Changes a rectangle in the format xyxy (x1, y1, x2, y2) to</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    the format xyhw (x, y, h, w)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Args :</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        x1 (float): x coordinate of the upper left point</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        y1 (float): y coordinate of the upper left point</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        x2 (float): x coordinate of the bottom right point</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        y2 (float): y coordinate of the bottom right point</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        float: x coordinate of the upper left point</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        float: y coordinate of the upper left point</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        float: height of the rectangle</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        float: width of the rectangle</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>